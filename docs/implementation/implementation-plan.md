# OPUS実装計画書

## 1. プロジェクト概要

### 1.1 システム概要

- システム名: OPUS (Outsourcing Process Unification System)
- 目的: 業務委託先管理、受発注管理、請求書管理の統合システム
- 対象ユーザー: 経理担当、購買担当など社内スタッフ

### 1.2 主要機能

- ユーザー管理 (FR-1~FR-3)
- 取引先管理 (FR-4~FR-6)
- 受発注管理 (FR-7~FR-9)
- 請求書管理 (FR-10~FR-13)

## 2. 技術スタック

### 2.1 テストフレームワーク構成

- ユニットテスト/コンポーネントテスト: Vitest
- E2Eテスト: Playwright
- 環境変数管理: .env.test(開発・CI共通)

### 2.2 テスト設定詳細

- Vitest設定:
  - environment: "jsdom"
  - setupFiles: vitest.setup.ts
  - testTimeout: 30000ms
  - maxWorkers: 50%
- Playwright設定:
  - auth.setup.tsによる認証状態管理
  - test-results/ディレクトリでのアーティファクト管理
  - 並列実行時のテスト分離対策

## 3. 実装フェーズ

### Phase 1: 基盤整備 (Week 1-2)

#### Week 1: 認証/セッション管理

- [x] セッションストレージの永続化実装
  - Redisを使用した永続化が実装済み
  - エラーハンドリングとリトライ機構も実装済み
- [x] NextAuth設定の最適化
  - JWT + Redisのハイブリッド実装
  - カスタムセッション型とコールバック実装済み
- [x] モックセッション機能の実装
  - 認証済み/未認証/ローディング状態のモック
  - テストヘルパーとアサーション実装済み

#### Week 2: テスト基盤の確立

- [x] Vitestの設定調整
  - カバレッジ設定(80%閾値)
  - テスト分離とランダム実行
  - リトライ機構の実装
- [x] Playwrightテスト環境の構築
  - 認証セットアップの実装
  - エラーハンドリングとスナップショット
  - タイムアウト最適化
- [x] CI環境での.env.test統合
  - 環境変数の統一管理
  - CI用の実行設定調整

### Phase 2: 機能実装 (Week 3-6)

#### Week 3-4: 取引先・受発注管理

- [x] 取引先CRUD機能の実装
  - 基本情報(名前、住所等)の管理
  - 銀行情報の管理
  - バリデーション実装
- [x] タグ管理システムの実装
  - タグの追加/削除
  - タグによるフィルタリングUI
- [x] 取引先検索/フィルタリング機能の実装
  - キーワード検索(取引先名、コード)
  - 区分フィルター(法人/個人)
  - ステータスフィルター(有効/無効/ブロック)
  - タグフィルター(複数選択可)
  - リスト/グリッド表示切り替え
- [x] 発注書作成・管理機能の実装
  - 品目一覧の大量データ入力対応
  - ステータス管理システム
  - バリデーション強化
    - 部門別の上限金額チェック
    - 与信限度額チェック
    - 品目数の上限設定（最大50品目）
    - 特定カテゴリー（IT機器等）の承認フロー
    - 重複品目チェック
  - バリデーションテストの実装
    - 各バリデーションルールの正常系・異常系テスト
    - エッジケースのテスト
- [ ] 進捗管理システムの実装
  - ステータス変更履歴
  - メール通知連携

#### Week 5-6: 請求書管理

- [ ] InvoiceFormの不具合修正
  - [ ] initialDataにおけるunitPrice、taxRateの数値変換ロジックの修正
  - [ ] 金額計算結果UI（小計、税額、合計）の実装
  - [ ] 単体テストの実施と確認
- [ ] インボイス制度対応機能の実装
- [ ] PDF出力機能の実装
- [ ] メール送信システムの実装(モック対応含む)
- [ ] ステータス管理・バリデーション実装

### Phase 3: 最適化・セキュリティ強化 (Week 7-8)

#### Week 7: パフォーマンス最適化

- [ ] 大量データ処理の最適化
- [ ] ページロード時間の改善
- [ ] E2Eテストの実行時間最適化

#### Week 8: セキュリティ対策

- [ ] HTTPS通信の確認
- [ ] XSS/CSRF対策の実装
- [ ] 権限管理システムの強化

## 4. 品質目標

### 4.1 テストカバレッジ

- ユニットテスト/コンポーネントテスト: 80%以上
- E2Eテスト実行時間: 15分以内
- 主要ページの読み込み時間: 2秒以内

### 4.2 監視項目

- テスト実行結果とスクリーンショット
- 認証エラーとCSR/SSR競合の監視
- メール送信システムの動作確認(本番/テスト環境の分離)
- パフォーマンスメトリクス(読み込み時間、メモリ使用量)

## 5. リスク管理

### 5.1 技術的リスク

- セッション管理の永続化移行における互換性
- 大量データ処理時のパフォーマンス
- テスト環境と本番環境の差異
- メール送信システムの誤送信防止

### 5.2 対策

- 段階的な機能リリースと継続的なモニタリング
- 本番環境に影響を与えないテスト用モックの実装
- 定期的なパフォーマンステストとログ分析
- 環境変数による厳密な環境分離

## 6. 承認依頼事項

以下の点について、管理者の承認を求めます:

1. 段階的実装計画の妥当性
2. テスト戦略とカバレッジ目標の適切性
3. リスク対策の十分性

この実装計画は、要件定義書(req_def.md)、テスト要件書(req_test.md)、およびPMからの指示書(fromPM.md)に基づいて作成されています。

## 7. 進捗報告

### 2025/2/2

#### 完了タスク

1. InvoiceFormの不具合修正
   - initialDataにおけるunitPrice、taxRateの数値変換ロジックを修正
     - Decimal型からの適切な変換処理を実装
     - OrderItemsFormの実装に合わせて処理を統一
   - 金額計算結果UI(小計、税額、合計)の改善
     - レイアウトとスタイルを整理
     - 3桁区切りと円記号の表示を統一
   - テストケースの追加
     - Decimal型の変換に関するテストを実装
     - 金額計算の正確性を確認するテストを追加

#### 実装計画 (2025/2/2 - 2025/2/16)

1. インボイス制度対応機能の実装 (2025/2/2 - 2025/2/6)

   Day 1-2: バリデーション強化

   - [ ] 登録番号のバリデーション強化
     - commonValidation.tsの既存ロジックを活用
     - エラーメッセージの多言語対応準備
     - テストケースの拡充
   - [ ] 税率選択UIの改善
     - 軽減税率(8%)と標準税率(10%)の選択UI実装
     - 税率に応じた計算ロジックの実装
     - 金額計算のテスト強化

   Day 3-4: 軽減税率対応

   - [x] 軽減税率対象品目の判定ロジック実装
     - 品目マスタとの連携
       - ItemCategoryMasterモデルの追加
       - マイグレーションファイルの作成
     - 自動税率判定機能の実装
       - カテゴリーに基づく税率自動判定
       - 軽減税率対象品目の判定ロジック
     - バリデーションルールの追加
       - itemCategorySchema実装
       - 多言語対応メッセージ
   - [x] 品目カテゴリー選択UI実装
     - ItemCategorySelectコンポーネント作成
     - グループ別表示(軽減税率/標準税率)
     - カテゴリー説明の表示
     - テストケースの実装

2. PDF出力機能の実装 (2025/2/7 - 2025/2/11)

   Day 1-2: テンプレート作成

   - [x] PDFテンプレートの作成
     - インボイス制度対応フォーマットの作成
       - 登録番号の表示
       - 適格請求書等の表示
       - 軽減税率対応の注記
     - 品目カテゴリー対応
       - カテゴリー情報の表示
       - 軽減税率対象品目の視覚的な区別
       - カテゴリーごとの集計
     - レイアウトの最適化
       - 明細行の表示改善
       - 税率区分ごとの集計表示
       - 注記の配置

   Day 3-4: 動的生成機能

   - [~] プレビュー機能の実装
     - [x] プレビューモーダルの作成
     - [x] 印刷プレビューの最適化
     - [x] ダウンロード機能の追加
     - [ ] 型エラーの修正
       - InvoicePreviewModal.test.tsx: TaxCalculationの型定義の問題
       - smtp.ts: MailContextのジェネリック型の問題
       - invoiceCreated.ts: MailTemplateの型定義の問題
       - itemCategory.ts: Prismaモデルの問題
       - pdf/utils.ts: QualifiedInvoiceItemの型定義の問題

   残課題:

   1. 型の不整合

      - QualifiedInvoiceとPDFテンプレートの型の差異
      - メール送信機能の型定義の問題
      - 品目カテゴリーのPrismaモデルの問題

   2. 必要な対応

      - TaxCalculationの型定義の見直し
      - MailTemplateのジェネリック型の改善
      - Prismaスキーマの更新(itemCategoryMaster)
      - テストデータの型安全性の向上

   3. 承認依頼事項
      - 型定義の方針(特にTaxCalculationとMailTemplate)
      - Prismaスキーマの変更方針
      - テストデータの扱い方

3. メール送信システム実装 (2025/2/12 - 2025/2/16)

   Day 1-2: 基盤整備

   - [ ] メールテンプレートの作成
     - 請求書送信用テンプレート
     - ステータス通知用テンプレート
   - [ ] 送信処理のモック実装
     - テスト環境用の送信処理
     - エラーハンドリング実装

   Day 3-4: 通知システム連携

   - [ ] ステータス変更時の通知実装
     - イベントハンドリングの実装
     - 通知条件の設定
   - [ ] 送信履歴の管理機能
     - 履歴テーブルの設計
     - UI実装

#### 品質管理計画

1. テスト戦略

   - ユニットテスト
     - バリデーションロジックのテスト
     - 計算ロジックのテスト
     - エラーハンドリングのテスト
   - E2Eテスト
     - 請求書作成から送信までのフロー
     - PDF出力とプレビュー機能
     - メール送信機能

2. パフォーマンス目標

   - ページロード: 2秒以内
   - PDF生成: 3秒以内
   - バリデーション処理: 100ms以内

3. セキュリティ考慮事項
   - メール送信時の認証情報管理
   - PDF出力時のアクセス制御
   - 権限に基づくUI制御

### 2025/1/31

#### 完了タスク

1. Phase 1の全タスクが完了

   - 認証/セッション管理の実装(Redis永続化、NextAuth最適化)
   - テスト基盤の確立(Vitest設定、Playwright環境構築)

2. Phase 2の一部タスクが完了

   - 取引先CRUD機能の実装
   - タグ管理システムの実装
   - Jest→Vitestへの完全移行
   - 取引先検索/フィルタリング機能の実装
     - キーワード検索(取引先名、コード)
     - 区分/ステータス/タグによるフィルタリング
     - リスト/グリッド表示切り替え
     - Vitestによるテスト実装
   - 取引先ポータルの実装
     - 基本UI構造の実装
     - 請求書一覧表示
     - ステータス別集計
     - 請求書作成ボタンの配置
     - 取引先情報との連携
     - 命名の最適化（フリーランサー→取引先ポータル）

3. テストフレームワーク関連の課題対応完了
   - InvoicePdfButton.test.tsx
     - 型エラーの修正(bankInfoをJSON文字列化)
     - QualifiedInvoice型の適用
   - OrderItemsTable.test.tsx
     - Jest関連の関数をVitest関数に変更
   - Tag.test.tsx
     - toHaveClass()の引数形式を修正

#### 次のステップ

1. 取引先ポータルの機能拡充

   - [ ] 請求書作成フォームの実装
     - react-hook-formの設定
     - バリデーションルールの実装
     - エラーハンドリングの実装
   - [ ] PDF出力機能の実装
   - [ ] メール通知システムの実装

2. 発注書作成・管理機能の実装

   - [x] 品目一覧の大量データ対応
     - 仮想スクロールによるパフォーマンス最適化
     - リアルタイムバリデーション実装
     - 入力値の変更時のdebounce処理追加
   - [x] ステータス管理システムの構築
     - ステータス変更履歴の表示
     - ステータス遷移の制御
     - 通知機能の実装
   - [x] バリデーション機能の実装
     - バリデーションスキーマの定義
     - エラー表示コンポーネントの実装
     - アクセシビリティ対応

## 8. 技術的課題の報告

### 2024-03-XX - ランタイムエラー対応とフリーランサー機能の実装計画

#### 現状の課題

1. ランタイムエラーの分析と対応

   - 取引先管理・発注書機能での画面遷移時のエラー
   - フロント側のルーティングとフォーム画面の連携に関する問題
   - 原因の切り分け（UI/API連携）が必要

2. 外部ユーザー向け請求書機能（FR-10）の実装

   - 外部ユーザー用ロール設定の実装
   - 請求書作成UIの制御（外部ユーザー用ダッシュボード）
   - インボイス制度対応の実装

3. 型システムとバリデーションの改善
   - スキーマと型定義の一貫性維持
   - フォーム初期値の適切な設定
   - `Decimal`型と`number`型の変換処理

#### 対応方針

1. ランタイムエラーへの対応

   - 優先度による分類
     - 致命的エラー → 即時対応
     - 軽微なエラー → 次の統合テストフェーズで対応
   - デバッグ手順
     - エラーログとスタックトレースの詳細分析
     - UI要素、ルーティング設定、状態管理の確認
     - 影響範囲の特定と修正計画の立案

2. 外部ユーザー機能の実装

   - ロール設定
     - "freelancer"/"vendor" ロールの追加
     - 権限に基づくUI制御の実装
   - 請求書作成フロー
     - 外部ユーザー用ダッシュボードの実装
     - インボイス制度対応（登録番号、税率）
     - PDF出力・送信機能の実装

3. テスト戦略の強化
   - E2Eテストの拡充
     - 外部ユーザーのログインフロー
     - 請求書作成・提出フロー
     - ステータス変更のテスト
   - 型定義の自動テスト
     - スキーマと型の整合性チェック
     - バリデーションルールのテスト

#### スケジュール

1. Week 1-2: ランタイムエラー対応

   - エラーの分析と優先度付け
   - 致命的エラーの即時修正
   - デバッグ環境の整備

2. Week 3-4: 外部ユーザー機能実装

   - ロール設定とUI制御
   - 請求書作成フローの実装
   - インボイス制度対応

3. Week 5-6: テスト強化とバグ修正
   - E2Eテストの拡充
   - 型定義の自動テスト実装
   - 残存する軽微なエラーの修正

#### 品質目標

1. パフォーマンス

   - ページロード2秒以内
   - E2Eテスト15分以内完走

2. テストカバレッジ

   - ユニット/コンポーネント: 80%以上
   - E2Eテスト: 主要フロー網羅

3. エラー管理
   - 致命的エラー: 即時対応
   - 軽微なエラー: 計画的な修正

## 進捗状況

### 2024-03-XX - 型システムの改善と整理

#### 完了した作業

- InvoiceFormの型定義を改善
  - `InvoiceFormDataWithRHF`型の必須フィールドを明確化
  - `AccountType` enumの適切な使用を実装
  - `Decimal`型とnumber型の変換ロジックを整理
  - フォームの初期値設定を改善し、必須フィールドの値を保証

#### 技術的な改善点

1. スキーマと型の一貫性

   - Zodスキーマと TypeScript型の定義を完全に一致させた
   - 必須フィールドの扱いを統一（スキーマ側とTS型で一貫性を確保）

2. フォームデータの初期化

   - `baseDefaultValues`で基本の初期値を定義
   - `initialData`とのマージ時に必須フィールドの値を保証
   - 配列要素（items, tags）の必須フィールドも適切に初期化

3. 型変換の整理
   - フォーム上では`number`型として扱い、API送信時に`Prisma.Decimal`に変換
   - 型変換ロジックを`toInvoiceCreateInput`関数に集約

#### 次のステップ

1. 同様の型システムの改善を他のフォームコンポーネントにも適用
2. バリデーションメッセージの国際化対応の検討
3. 型定義の自動テスト導入の検討
