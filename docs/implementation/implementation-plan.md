# OPUS実装計画書

## 1. プロジェクト概要

### 1.1 システム概要

- システム名: OPUS (Outsourcing Process Unification System)
- 目的: 業務委託先管理、受発注管理、請求書管理の統合システム
- 対象ユーザー: 経理担当、購買担当など社内スタッフ

### 1.2 主要機能

- ユーザー管理 (FR-1~FR-3)
- 取引先管理 (FR-4~FR-6)
- 受発注管理 (FR-7~FR-9)
- 請求書管理 (FR-10~FR-13)

## 2. 技術スタック

### 2.1 テストフレームワーク構成

- ユニットテスト/コンポーネントテスト: Vitest
- E2Eテスト: Playwright
- 環境変数管理: .env.test(開発・CI共通)

### 2.2 テスト設定詳細

- Vitest設定:
  - environment: "jsdom"
  - setupFiles: jest.setup.ts
  - testTimeout: 30000ms
  - maxWorkers: "50%"
- Playwright設定:
  - auth.setup.tsによる認証状態管理
  - test-results/ディレクトリでのアーティファクト管理
  - 並列実行時のテスト分離対策

## 3. 実装フェーズ

### Phase 1: 基盤整備 (Week 1-2)

#### Week 1: 認証/セッション管理

- [x] セッションストレージの永続化実装
  - Redisを使用した永続化が実装済み
  - エラーハンドリングとリトライ機構も実装済み
- [x] NextAuth設定の最適化
  - JWT + Redisのハイブリッド実装
  - カスタムセッション型とコールバック実装済み
- [x] モックセッション機能の実装
  - 認証済み/未認証/ローディング状態のモック
  - テストヘルパーとアサーション実装済み

#### Week 2: テスト基盤の確立

- [x] Vitestの設定調整
  - カバレッジ設定(80%閾値)
  - テスト分離とランダム実行
  - リトライ機構の実装
- [x] Playwrightテスト環境の構築
  - 認証セットアップの実装
  - エラーハンドリングとスナップショット
  - タイムアウト最適化
- [x] CI環境での.env.test統合
  - 環境変数の統一管理
  - CI用の実行設定調整

### Phase 2: 機能実装 (Week 3-6)

#### Week 3-4: 取引先・受発注管理

- [x] 取引先CRUD機能の実装
  - 基本情報(名前、住所等)の管理
  - 銀行情報の管理
  - バリデーション実装
- [x] タグ管理システムの実装
  - タグの追加/削除
  - タグによるフィルタリングUI
- [ ] 取引先検索/フィルタリング機能の実装
  - キーワード検索
  - 詳細フィルター
  - ソート機能
- [ ] 発注書作成・管理機能の実装
- [ ] 進捗管理システムの実装

#### Week 5-6: 請求書管理

- [ ] インボイス制度対応機能の実装
- [ ] PDF出力機能の実装
- [ ] メール送信システムの実装(モック対応含む)
- [ ] ステータス管理・バリデーション実装

### Phase 3: 最適化・セキュリティ強化 (Week 7-8)

#### Week 7: パフォーマンス最適化

- [ ] 大量データ処理の最適化
- [ ] ページロード時間の改善
- [ ] E2Eテストの実行時間最適化

#### Week 8: セキュリティ対策

- [ ] HTTPS通信の確認
- [ ] XSS/CSRF対策の実装
- [ ] 権限管理システムの強化

## 4. 品質目標

### 4.1 テストカバレッジ

- ユニットテスト/コンポーネントテスト: 80%以上
- E2Eテスト実行時間: 15分以内
- 主要ページの読み込み時間: 2秒以内

### 4.2 監視項目

- テスト実行結果とスクリーンショット
- 認証エラーとCSR/SSR競合の監視
- メール送信システムの動作確認(本番/テスト環境の分離)

## 5. リスク管理

### 5.1 技術的リスク

- セッション管理の永続化移行における互換性
- 大量データ処理時のパフォーマンス
- テスト環境と本番環境の差異

### 5.2 対策

- 段階的な機能リリースと継続的なモニタリング
- 本番環境に影響を与えないテスト用モックの実装
- 定期的なパフォーマンステストとログ分析

## 6. 承認依頼事項

以下の点について、管理者の承認を求めます:

1. 段階的実装計画の妥当性
2. テスト戦略とカバレッジ目標の適切性
3. リスク対策の十分性

この実装計画は、要件定義書(req_def.md)、テスト要件書(req_test.md)、およびPMからの指示書(fromPM.md)に基づいて作成されています。

## 7. 進捗報告

### 2025/1/31

- Phase 1 Week 1の認証/セッション管理タスクが完了

  - Redisを使用したセッションの永続化が実装済み
  - NextAuthの設定が最適化済み
  - モックセッション機能が実装済み

- Phase 1 Week 2のテスト基盤確立タスクが完了

  - Vitestの設定が最適化済み(カバレッジ、テスト分離、リトライ機構)
  - Playwrightテスト環境が構築済み(認証セットアップ、エラーハンドリング)
  - CI環境との統合が完了(環境変数、実行設定)

- Phase 2 Week 3-4の取引先管理機能の一部が完了
  - 取引先CRUD機能が実装済み(基本情報、銀行情報、バリデーション)
  - タグ管理システムが実装済み
  - 次のステップとして検索/フィルタリング機能の実装を開始予定

## 8. 技術的課題の報告

### Jest→Vitest移行の残作業

現在、テストフレームワークの移行に関して以下の課題が発見されました:

1. Jest関連の依存関係が残存

   - @jest/types
   - @jest/globals
   - jest.config.tsの存在

2. テストヘルパーの修正必要

   - src/test/helpers/mockHelpers.ts
   - src/test/helpers/testUtils.ts
   - jest.setup.ts

3. Vitestの設定調整
   - maxWorkersの型エラー修正必要
   - テスト実行環境の整理必要

### 対応方針の承認依頼

以下の対応方針について承認を求めます:

1. Jest関連ファイルの完全削除

   - jest.config.ts
   - jest.setup.ts (Vitestの設定に統合)

2. テストヘルパーの書き換え

   - Jest APIをVitest APIに置換
   - グローバル関数の互換性対応

3. 移行手順
   1. Jest関連パッケージの削除
   2. Vitestの設定ファイル修正
   3. テストヘルパーの書き換え
   4. CIパイプラインの更新

この移行作業は既存のテストコードに広範な影響を与える可能性があるため、慎重な計画と実行が必要です。
管理者からの承認を受け、以下の手順で移行を実施します。

### Jest→Vitest移行手順

#### 1. Jest関連ファイルの削除

1. jest.config.tsの削除

   - ファイルごと削除
   - Vitest設定ファイルへ一本化

2. jest.setup.tsの移行

   - vitest.setup.tsへリネーム
   - Jest特有のモジュール確認
   - @testing-library/jest-domの互換性確認

3. Jest依存パッケージの削除

   - @jest/types
   - @jest/globals
   - jest
   - 関連パッケージのアンインストール

4. tsconfig.jsonの修正
   - Jest関連の型定義削除
   - mocha型定義の削除

#### 2. テストヘルパーの書き換え

- src/test/helpers/mockHelpers.ts
- src/test/helpers/testUtils.ts
- Jestグローバル関数のVitest APIへの置換
- import文の明示的な追加

#### 3. Vitestの設定調整

1. maxWorkersの型エラー修正

   - パーセンテージ指定を数値に変換
   - 例: '50%' → 0.5

2. 設定ファイルの整理

   - setupFilesの指定
   - testTimeoutの設定
   - environment設定の移行

3. CI/CD設定の更新
   - Jestコマンドの置換
   - Vitestコマンドへの移行

#### 4. 実施ステップ

1. 依存関係の整理

   - パッケージのアンインストール
   - 設定ファイルの修正

2. ファイル移行

   - jest.config.ts削除
   - jest.setup.ts → vitest.setup.ts

3. コード修正

   - テストヘルパーの書き換え
   - グローバル関数の置換

4. 設定調整

   - maxWorkers設定の修正
   - 環境設定の最適化

5. 動作確認
   - ローカルテスト実行
   - CIパイプラインの確認
   - カバレッジレポートの検証

この移行計画に基づき、段階的に実施を進めていきます。
