# 統合指示文書 (最新版)

このドキュメントは、OPUSの機能要件・テスト方針、実装計画（@implementation-plan.md）の進捗状況および現行コードの検証結果に基づき、以後の実装指示を統合した最新版です。不要となった旧指示内容は削除し、更新内容は更新履歴に記載しています。各チームは以下の内容に沿って作業を進め、定期的な進捗報告およびGitコミットによる履歴管理を徹底してください。

---

## 1. OPUSの機能要件・仕様

本システムは、業務委託先情報管理、受発注管理、請求書管理を一元的に行うWebアプリケーションです。外部フリーランサーや取引先法人もOPUSへログインし、請求書を直接作成・提出できる仕組み（FR-10）を備えています。詳細な要件や各種画面・機能の仕様については、@req_def.md に記載済みです。

---

## 2. テストフレームワークとテスト戦略

- **ユニット/コンポーネントテスト:** Vitestを活用し、80%以上のカバレッジを目標とする。
- **E2Eテスト:** Playwrightを使い、主要なユーザ操作フローをシミュレーションする。  
  テスト実行時には .env.test を利用し、CI環境とも整合性をとること。
- **設定概要:**
  - Vitest: environment "jsdom", setupFiles (例: vitest.setup.ts)、testTimeout 30000ms、maxWorkers 50%。
  - Playwright: auth.setup.ts による認証状態管理、スクリーンショットやHTMLスナップショットの出力先は test-results/。

---

## 3. 実装フェーズと計画

現時点では Phase 1（基盤整備）は完了、Phase 2（機能実装）が進行中です。@implementation-plan.md の進捗報告を踏まえ、以下の項目を優先的に実施してください。

### 3.1 型システム・フォーム改善

- InvoiceFormの型定義や初期値設定をはじめ、各フォームコンポーネントの型整合性およびバリデーションルールの統一を徹底する。
- ZodスキーマとTypeScript型の一致を確認し、型変換ロジック（toInvoiceCreateInput関数等）のテスト自動化導入を検討する。

---

## 型定義について

- 単一ソース・オブ・トゥルースの原則:
  - 同じ概念の型定義（TaxCalculation、QualifiedInvoiceItem など）が複数ファイルに重複しないよう、@/types 配下に集約する。
  - DB 用・ビュー用・テスト用などで型構造が変わる場合は、Base/Db/View のように定義を分け、それらの相互変換をユーティリティ関数として一元管理する。
- Base/Db/View レイヤー分割:
  - 型定義は Base/Db/View の3層構造で管理し、各レイヤーの役割を明確にする。
- 詳細なディレクトリ構成・命名規則は [type-definition-guide.md](./type-definition-guide.md) を参照。

【ガイドライン追記】

- 型のバージョン管理:

  - 既存の型定義を変更・拡張する場合は、可能な限り既存モジュールを修正し、新ファイルの乱立を防止する。古い型は速やかに削除し、一貫性を保つ。

- エクスポートルール:

  - ステータスやロール定義 (InvoiceStatusManager、UserRole など) は、必ず定義先で export し、必要箇所で import する形を遵守する。
  - メール送信用の型 (MailInvoice など) も同様に、src/lib/mail/types.ts などで一元管理し、複数箇所に重複定義しないこと。

- パスエイリアス・tsconfig.json の整備:

  - "@/types" "@/domains" "@/lib" などのエイリアスを利用し、相対パスのごちゃごちゃや重複呼び出しを最小限に抑える。
  - ルートディレクトリ構造を変更した場合は速やかに tsconfig.json 等を更新して、パス解決ミスを防ぐ。

- テストデータ生成の統一:

  - ファクトリ関数 (例: createTestInvoice, createTestTaxCalculation) は @/test/factories/ に集約し、一度の修正で全テストに反映できるようにする。
  - テストコード側で独自に型を再定義しないよう注意すること。

- エラーチェックとリグレッション:

  - 新たに型定義を変更した際は、tsc および ESLint の実行に加え、関連機能のユニットテスト、E2E テストを再度実行する。型エラーやランタイムエラーが生じていないか必ず確認する。

- 運用ルール:
  - プロジェクトレビュー時に、型定義やエクスポートの不整合が起きていないかチェックリストに含める。
  - 分散した型が見つかったときは技術的負債として報告し、整理を優先的に行う。

### 3.2 請求書作成機能（FR-10）およびインボイス制度対応

- 請求書作成フォームに、インボイス制度に準拠するための登録番号、税率などの項目を追加する。
- PDF出力機能やメール送信システム（モック実装）を強化し、エンドツーエンドでの連携テストを徹底する。

### 3.3 外部ユーザー向け機能の強化

- 外部ユーザー（フリーランサー、取引先法人）のためのログイン、請求書作成・提出機能のUI/UX改善を継続する。
- ロールによるアクセス制御や承認プロセスなど、セキュリティ要件への対応を確認・強化する。

### 3.4 発注書機能およびその他連携機能の検証

- 発注書機能では、大量品目入力やステータス管理、バリデーションロジックの安定動作を再検証する。
- Playwrightを用いたE2Eテストシナリオを拡充し、各機能間の連携およびUIの不整合が無いかを確認する。

### 3.5 次フェーズへ移行する前の最終チェック

- **エラー解消状況**  
  @linter_measures.md にあるエラー（UserRole, InvoiceStatusManager, tax計算型の不一致など）がすべて解消されていることを確認する。  
  既存の型定義ファイルや tsconfig.json のパスエイリアス、メール送信用型定義が最新化・整理済みである場合はOK。

- **@implementation-plan.md の進捗確認**

  - PDF生成機能のcategoryプロパティ、
  - メール送信用の型（MailInvoice / MailInvoiceItem）の定義、
  - 税計算の単一ソース・オブ・トゥルース化 といった項目が反映されているかチェック。
  - テストガイドや型定義ガイドが更新され、ファクトリ関数の整備やエッジケースのテストもカバーされているか確認する。

- **移行時の注意事項**
  - 次のフェーズ(Phase 3 or 4)などに進む際は、@req_def.md, @req_test.md, 本ドキュメント(@fromPM.md)の内容から外れていないかを確認する。
  - 新しく要件や型定義を追加する場合は @implementation-plan.md に追記し、コミットログや進捗レポートと連動させる。

---

## 4. 今後の実装指示

- **Gitコミットと進捗報告:** 各機能実装の完了ごとに、変更点、テスト結果を詳細に報告し、Gitコミットに反映すること。
- **エラー対応:** 開発中に発見されたランタイムエラーやUIの不整合は速やかに修正し、原因と影響範囲についてドキュメント化する。
- **ドキュメント更新:** 定期的に @implementation-plan.md の進捗と連動して、本ドキュメントもアップデートし、全体の仕様と実装方針が最新の状態になるようにする。

---

## 5. 更新履歴

- 2025/02/05: 旧内容の削除およびUI/UX改善、Gitコミット徹底に関する記述を追加。
- 202X/XX/XX: @implementation-plan.md の進捗に基づく実装指示の更新（本アップデート）。

---

## 追加指示（エージェントへの検証タスク）

**以下のタスクをエージェントが実施し、結果レポートを提出すること：**

1. コードベース全体のディレクトリ構成および tsconfig 設定の整合性をチェックする。
2. エイリアス設定を含めて、各種型定義ファイル (Base/Db/View など) の重複や不整合がないか検証する。
3. Vitest および Playwright のテストが想定どおりにすべて成功しているか確認し、問題があれば詳細を報告する。
4. `@implementation-plan.md` および本ドキュメント内のガイドラインに沿って実装されているか、特にエクスポートルールやバリデーション設定、外部ユーザーのアクセス制御周りに齟齬がないかを点検する。
5. リンターエラーや型エラーが潜在的に残っていないかを確認し、修正すべき箇所があれば一覧化する。
6. 全検証の結果と改善案をまとめたレポートを提出すること。

エージェントは上記のチェックを進め、完了次第、Git上またはドキュメントで進捗を報告し、必要な修正提案があれば共有すること。万が一、大きな指示からの逸脱が発見された場合は速やかに報告し、承認依頼文書を作成して対応すること。

以上の内容に従い、作業を進めてください。仕様との乖離や不明点が発生した場合は速やかに管理者または責任者へ連絡すること。

---

## 6. 検証結果を踏まえた追加指示

- tsconfigの厳格設定（noImplicitAny, strictNullChecks, strictFunctionTypesなど）が無効化されているケースが確認されたため、最優先で修正すること。
- パスエイリアスの定義が「@/\*」のみになっている場合、@/types, @/domains, @/lib などの具体的な指定へ拡充すること。
- purchase-order.ts と purchaseOrder.ts のように同一機能を指す重複ファイルが散見されるため、命名規則を統一しつつ不要ファイルは速やかに削除し、レイヤー別定義 (Base/Db/View) を整理すること。
- レイヤー用の型定義ファイル (view/purchaseOrder.ts, db/purchaseOrder.ts など) が不足または分散しているケースを確認。今後のフェーズでの開発効率を下げないよう、早期に整備・統合すること。
- E2Eテストにおいては発注管理フローや請求書作成フローなどをさらに拡充し、カバレッジや安定性を高める施策も検討すること。
- ドキュメント面は、型定義ガイドやテストガイドに対して早急に追記・修正を行い、メンバー全員の認識合わせを円滑にすること。

エージェントは上記内容を参考に再度検証し、必要な修正を行ったうえで改めてレポートを提出してください。問題点や不明点があれば速やかに管理者または責任者へエスカレーションすること。
