# 統合指示文書 (最新版)

このドキュメントは、OPUSの機能要件・テスト方針、実装計画（@implementation-plan.md）の進捗状況および現行コードの検証結果に基づき、以後の実装指示を統合した最新版です。不要となった旧指示内容は削除し、更新内容は更新履歴に記載しています。各チームは以下の内容に沿って作業を進め、定期的な進捗報告およびGitコミットによる履歴管理を徹底してください。

---

## 1. OPUSの機能要件・仕様

本システムは、業務委託先情報管理、受発注管理、請求書管理を一元的に行うWebアプリケーションです。外部フリーランサーや取引先法人もOPUSへログインし、請求書を直接作成・提出できる仕組み（FR-10）を備えています。詳細な要件や各種画面・機能の仕様については、@req_def.md に記載済みです。

---

## 2. テストフレームワークとテスト戦略

- **ユニット/コンポーネントテスト:** Vitestを活用し、80%以上のカバレッジを目標とする。
- **E2Eテスト:** Playwrightを利用し、主要なユーザ操作フローをシミュレーションする。テスト実行時には .env.test を用い、CI環境との整合性を確保すること。
- **設定概要:**
  - Vitest: environment "jsdom", setupFiles（例: vitest.setup.ts）、testTimeout 30000ms、maxWorkers 50%。
  - Playwright: auth.setup.ts による認証状態管理、スクリーンショットやHTMLスナップショットの出力先は test-results/。

---

## 3. 実装フェーズと計画

現時点では Phase 1（基盤整備）は完了、Phase 2（機能実装）が進行中です。@implementation-plan.md の進捗報告を踏まえ、以下の項目を優先的に実施してください。

### 3.1 型システム・フォーム改善

- InvoiceFormの型定義や初期値設定をはじめ、各フォームコンポーネントの型整合性およびバリデーションルールの統一を徹底する。
- ZodスキーマとTypeScript型の一致を確認し、型変換ロジック（toInvoiceCreateInput関数等）のテスト自動化導入を検討する。

---

## 型定義について

- **単一ソース・オブ・トゥルースの原則:**
  - 同一概念の型定義（TaxCalculation、QualifiedInvoiceItem など）が複数ファイルに重複しないよう、@/types 配下に集約する。
  - DB用、ビュー用、テスト用など用途別に型構造が変わる場合は、Base/Db/View のように定義を分け、各レイヤー間の相互変換をユーティリティ関数で一元管理する。
- **Base/Db/View レイヤー分割:**
  - 型定義はBase/Db/View の3層構造で管理し、各レイヤーの役割を明確にする。
- 詳細なディレクトリ構成・命名規則は [type-definition-guide.md](./type-definition-guide.md) を参照する。

【ガイドライン追記】

- **型のバージョン管理:**
  - 既存の型定義を変更・拡張する場合は、既存モジュール内で修正し、新規ファイルの乱立を避ける。不要な古い型は速やかに削除し、一貫性を保つ。
- **エクスポートルール:**
  - ステータスやロール定義（InvoiceStatusManager、UserRole など）は定義先でexportし、必要箇所でimportする。
  - メール送信用の型（MailInvoice など）も例として、src/lib/mail/types.ts にて一元管理し、重複定義を避けること。
- **パスエイリアス・tsconfig.json の整備:**
  - "@/types", "@/domains", "@/lib" などのエイリアスを活用し、複雑な相対パスや重複呼び出しを最小限にする。
  - ルートディレクトリ構造変更時は、速やかに tsconfig.json 等を更新してパス解決ミスを防ぐ。
- **テストデータ生成の統一:**
  - ファクトリ関数（例: createTestInvoice, createTestTaxCalculation）は @/test/factories/ に集約し、一度の修正で全テストに反映させる。
  - テストコード内で独自に型定義を再定義しないこと。
- **エラーチェックとリグレッション:**
  - 型定義変更後は、tscおよびESLintのチェック、関連機能のユニットテストやE2Eテストを実行し、型エラーやランタイムエラーが無いことを確認する。
- **運用ルール:**
  - プロジェクトレビュー時に型定義やエクスポートの不整合が生じていないかチェックリストで確認する。
  - 分散している型が見つかった場合は、技術的負債として報告し、整理を優先する。

### 3.2 請求書作成機能（FR-10）およびインボイス制度対応

- 請求書作成フォームに、インボイス制度に準拠するための登録番号、税率などの項目を追加する。
- PDF出力機能やメール送信システム（モック実装）の強化、エンドツーエンドでの連携テストの徹底を行う。

### 3.3 外部ユーザー向け機能の強化

- 外部ユーザー（フリーランサー、取引先法人）のログイン、請求書作成・提出機能のUI/UX改善を継続する。
- ロールによるアクセス制御や承認プロセス等、セキュリティ要件への対応を確認・強化する。

### 3.4 発注書機能およびその他連携機能の検証

- 発注書機能において、大量品目の入力、ステータス管理、バリデーションロジックの安定動作を再検証する。
- Playwrightを用いたE2Eテストシナリオを拡充し、各機能間の連携およびUIの不整合が無いか確認する。

### 3.5 次フェーズへ移行する前の最終チェック

- **エラー解消状況**  
  @linter_measures.md に記載されたエラー（UserRole, InvoiceStatusManager, 税計算型の不一致等）が全て解消されていることを確認する。既存の型定義、tsconfig.jsonのパスエイリアス、メール送信用型定義が最新化・整理済みであればOK。
- **@implementation-plan.md の進捗確認**
  - PDF生成機能のcategoryプロパティ
  - メール送信用の型（MailInvoice / MailInvoiceItem）の定義
  - 税計算の単一ソース・オブ・トゥルース化  
    の各項目が反映され、テストガイドや型定義ガイドの更新、ファクトリ関数の整備、エッジケースのテストがカバーされているかを確認する。
- **移行時の注意事項**
  - 次のフェーズ（Phase 3 or 4）に進む際、@req_def.md, @req_test.md, 本ドキュメント（@fromPM.md）の内容と整合しているかを確認する。
  - 新たな要件や型定義を追加する場合は、@implementation-plan.md に追記し、Gitコミットログ・進捗レポートと連動させること。

---

## 4. 今後の実装指示

- **Gitコミットと進捗報告:**  
  各機能実装完了時には、変更内容とテスト結果を詳細に報告し、Gitコミットに反映すること。
- **エラー対応:**  
  開発中に発見されたランタイムエラーやUIの不整合は速やかに修正し、原因と影響範囲をドキュメント化すること。
- **ドキュメント更新:**  
  定期的に @implementation-plan.md の進捗と連動して、本ドキュメントも最新の状態にアップデートすること。

---

## 5. 更新履歴

- 2025/02/05: 旧内容の削除およびUI/UX改善、Gitコミット徹底に関する記述を追加。
- 202X/XX/XX: @implementation-plan.md の進捗に基づく実装指示の更新（本アップデート）。

---

## 追加指示（エージェントへの検証タスク）

以下のタスクをエージェントが実施し、結果レポートを提出すること：

1. コードベース全体のディレクトリ構成および tsconfig 設定の整合性をチェックする。
2. エイリアス設定を含め、各種型定義ファイル（Base/Db/View など）の重複や不整合がないか検証する。
3. Vitest および Playwright のテストが全て成功しているかを確認し、問題があれば詳細を報告する。
4. @implementation-plan.md および本ドキュメント内のガイドラインに沿って実装され、特にエクスポートルール、バリデーション設定、外部ユーザーのアクセス制御に齟齬がないか点検する。
5. リンターエラーや型エラーが潜在していないかを確認し、修正すべき箇所があれば一覧化する。
6. すべての検証結果と改善案をまとめたレポートを提出すること。

エージェントは上記のチェックを進め、完了次第Gitまたはドキュメント上で進捗を報告し、必要な修正提案を共有すること。大きな指示逸脱が発見された場合は速やかに報告し、承認依頼文書を作成すること。

---

## 6. 検証結果を踏まえた追加指示

- tsconfig の厳格設定（noImplicitAny, strictNullChecks, strictFunctionTypes など）が無効化されているケースが確認されたため、最優先で修正すること。
- パスエイリアスの定義が「@/\*」のみの場合、@/types、@/domains、@/lib など具体的な指定に拡充すること。
- purchase-order.ts と purchaseOrder.ts のように、同一機能を指す重複ファイルが存在する場合、命名規則を統一し不要なファイルは速やかに削除、レイヤー別定義（Base/Db/View）の整理を行うこと。
- 各レイヤーの型定義ファイル（例: view/purchaseOrder.ts, db/purchaseOrder.ts）が不足または散在している場合、早急に整備・統合すること。
- E2Eテストにおいては、発注管理フローや請求書作成フローをさらに拡充し、テストカバレッジや安定性向上の施策を検討すること。
- ドキュメント面では、型定義ガイドやテストガイドを早急に追記・修正し、全メンバーの認識が統一されるよう努めること。

エージェントは上記内容を踏まえ、再度検証し必要な修正を実施した上で、改めてレポートを提出すること。問題点や不明点があれば、速やかに管理者または責任者にエスカレーションすること。

---

## 7. 次フェーズ (Phase 4) の方針

Phase 1～3 を完了した現状を踏まえ、さらなる運用効率および拡張性向上を目指し、以下の追加タスクを検討する：

1. パフォーマンス最適化
   - 大量データを扱う際のクエリ効率化
   - キャッシュ戦略（APIレスポンスの短期キャッシュなど）の検討
   - フロントエンド側のレンダリング負荷の軽減
2. UI/UX向上施策
   - 統合的なデザインコンポーネントの導入（例: Storybookによるコンポーネント管理）の検討
   - 外部ユーザー向けUIの改善（請求書作成画面の操作性向上など）
3. CI/CDの強化
   - CIにて型チェック、リント、テスト自動化の推進
   - テスト結果レポートの可視化ツールの導入検討
   - デプロイパイプラインへの自動セキュリティスキャン導入
4. ドキュメント保守運用体制
   - 既存ドキュメントとの整合を保ちながら定期的に更新する
   - フィードバックサイクルを確立し、古い記述の早期発見を促す

以上を新フェーズの指針とし、具体的なスケジュールや要件は別途 @implementation-plan.md にて整理する。完了後は、エージェントが再度検証を実施し報告書を提出する流れとする。

エージェントおよび開発チームは本方針に準じ、必要に応じて承認依頼を行いながら、実装・テスト・検証を進めること。

## 8. 次フェーズ (Phase 4) の新たな指示

以下は次フェーズに向けた具体的な実装、検証、品質向上の指示です。各タスクは、現フェーズまでの実績を踏まえ、さらに運用効率と拡張性を向上させるために実施してください。

### 8.1 パフォーマンス最適化

- **データベースの最適化:**
  - 大量データ処理時のクエリ効率化（インデックス見直し、バッチ処理の検討）を実装する。
  - APIレスポンスのキャッシュ戦略（Redis 等の利用）の検討と導入を進める。
- **フロントエンドのパフォーマンス:**
  - コンポーネントの最適化、Lazy Loading などを採用し、初回ロードや再描画の負荷軽減を図る。
  - 実測データに基づき、レンダリング最適化の施策を取り入れる。

### 8.2 UI/UX 向上

- **デザインコンポーネントの統一:**
  - 統合的なデザインコンポーネントライブラリ（例: Storybook）の導入や、既存のコンポーネントの再整理を実施する。
- **ユーザビリティテスト:**
  - 外部ユーザー向けログインや請求書作成画面の操作性改善のため、ユーザテストを実施しフィードバックを迅速に反映する。
- **アクセシビリティ:**
  - キーボードナビゲーション、スクリーンリーダー対応など、アクセシビリティの検証と実装を進める。

### 8.3 CI/CD の強化と自動化

- **自動テストと解析:**
  - CI 環境における型チェック、静的解析、リント、テスト自動実行をさらに強化する。
  - テスト結果の可視化ツール（例: Allure、SonarQube 等）を導入し、定期的なレポート作成とフィードバックを実施する。
- **自動デプロイ及びセキュリティ対策:**
  - セキュリティスキャンや依存関係のチェックを含む自動デプロイパイプラインの拡充を行い、リリースプロセスの安全性を確保する。

### 8.4 ドキュメント保守運用体制の確立

- **ドキュメントの定期更新:**
  - 型定義ガイド、テストガイド、開発手順書等のドキュメントを定期的に見直し、全メンバーに最新の情報を共有する仕組みを構築する。
- **変更管理の徹底:**
  - 型定義やAPI仕様に変更があった場合、関連テスト・ドキュメントの更新が必ず実施されるよう、変更管理プロセスを厳守する。
- **レビューの仕組み:**
  - 定期的なドキュメントレビューを実施し、技術的負債や記述の不整合を早期に発見・修正する。

### 8.5 移行及びリグレッションテストの徹底

- **テスト戦略:**
  - 各フェーズ終了後に、移行テスト、エンドツーエンドテスト（E2Eテスト）、およびリグレッションテストを徹底し、既存機能への影響がないことを確認する。
- **テストケースの追加と更新:**
  - 新たな型定義や機能追加時には、既存テストとの整合性を必ずチェックし、必要なテストケースの追加・修正を実施する。

---

## 9. 次フェーズ開始時の検証と報告

新規フェーズの開始前に、以下の検証・確認を必ず実施してください。

- 全タスクの実装完了後、リグレッションテストおよび E2E テストの全体実行と結果確認を行う。
- CI/CD パイプラインの動作状況、テストレポートの生成状況を確認し、問題があれば速やかに対処する。
- 各チームは進捗報告、コミット履歴の整理を徹底し、必要に応じて承認依頼文書を作成する。
- 残課題や改善点があれば、それらをまとめたレポートを提出し、全体会議等で共有する。

以上をもって、次フェーズ（Phase 4）の指針とします。エージェントおよび開発チームは、この指示に基づき新たなタスクに着手し、適宜報告・検証を進めるようにしてください。
