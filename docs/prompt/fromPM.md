# 統合指示文書 (最新版)

本ドキュメントでは以下の点をまとめている:

1. OPUS（Outsourcing Process Unification System）の機能要件・仕様
2. テストフレームワークおよびテスト方針
3. 実装計画と留意すべき技術的課題
4. PMや関係者からの要望・ポリシー

今後はエージェントとして作業する際、この文書を参照しながら進めてほしい。過去作業の詳細な履歴は省いているから、必要があれば履歴管理(Gitや過去チケットなど)を個別に見直してね。

---

## 1. OPUSの機能要件・仕様 (抜粋)

(OPUSが備える機能の概要は @req_def.md で示されてきた内容を参考にしている)

- システム概要:

  - 業務委託先(取引先)の基本情報管理、受発注管理、請求書管理などを行うWebアプリ。
  - 経理担当・購買担当など社内スタッフが主な利用者。
  - また、フリーランサーや取引先法人側のユーザー(外部ユーザー)がOPUSにログインし、請求書を直接作成・提出する流れもサポートする(FR-10)。
  - 主たる目的は「請求書の発行から受領、支払までを一元管理する」こと。

- 請求書管理機能のポイント
  - 社内側が代理で請求書を作成する場合(一部社内業務で必要)と、フリーランサーがOPUSにログインして自分で請求書を発行する場合、両方に対応。
  - 外部で作成・送付されたPDF請求書でも手動/自動登録対応可能 (FR-14)。
  - インボイス制度(登録番号、税率)に準拠し、ステータス管理(承認待ち、支払済みなど)を行う。

その他の詳細は省略（必要に応じて @req_def.md を参照）。

---

## 2. テストフレームワークと方針 (確定版)

(@req_test.md の内容をもとに、最新の指示や方針をまとめてある)

1. テストランナー:

   - メインは Vitest (ユニットテスト・コンポーネントテスト用)。
   - E2Eテストは Playwright を採用し、暫定的に vitest.config.ts や playwright.config で設定を管理。
   - 既存の Jest は利用しない（廃止済みのため、切り替え提案は行わない）。

2. テスト環境:

   - テスト専用の環境変数(.env.test)を使用。
   - CIでも同様に .env.test を用いて統一的に挙動を保証する。

3. テスト設定:

   - Vitest では environment="jsdom" を基本とし、setupFiles で jest.setup.ts (or vitest.setup.ts) を読み込む。
   - testTimeout は 30000ms 程度を目安にし、大規模E2Eテストが落ちづらいようにする。
   - maxWorkers は "50%" を推奨。

4. Playwright E2E:

   - 認証のセットアップや SSR/CSRのハイドレーション待ちのために waitForLoadState や waitForSelector を活用。
   - auth.setup.ts で先にログイン状態(StorageState)を生成し、ストレージを使い回す方式が基本。
   - スクリーンショットやHTMLスナップショットは test-results/ 以下へ保存。
   - mode: 'parallel' などで並列実行を指定する場合、テスト間の干渉が起きないよう注意。

5. モック/スタブ:
   - 認証系(mockSession)やメール送信(mockSendEmail)など、本番接続を避ける箇所は明示的にモックを切り替える仕組みを用意する。
   - 本番環境に影響しないように必ず環境変数か構成で制御。

このルールは現時点で正式な指示とし、勝手なフレームワーク移行や変更は行わないこと。

---

## 3. 実装計画の概要

(@handover.md で示される実装計画に基づく)

### 3.1 優先度の高い技術的課題

- 認証システムの安定化
  - セッション管理(インメモリ→永続化ストレージへの移行、NextAuth/モックセッションなど)
- テスト基盤の最適化
  - CIと環境変数(.env.test)の連携、PlaywrightとVitestの共存、タイムアウト最適化
- メールシステムの分離
  - モックメール送信と本番切り替えの明確化

### 3.2 段階的実装計画

- Phase 1: 基盤整備
  - 認証/セッション管理(Week1) → テスト基盤の確立(Week2)
- Phase 2: 機能実装
  - 取引先管理、受発注管理(Week3-4) → 請求書管理(Week5-6)
- Phase 3: 最適化・セキュリティ強化
  - パフォーマンス最適化(Week7) → セキュリティ対策(Week8)

### 3.3 テスト戦略・カバレッジ目標

- ユニットテスト/コンポーネントテストで80%以上のカバレッジを目標。
- E2Eテストは15分程度で完走できるよう調整(タイムアウト値や並列実行)。
- リトライやスクリーンショット、ログ収集などで不安定テストに備える。

---

## 4. PMからの要望・運用上の注意

(@fromPM.md の内容より、今後も重要な情報のみ抜粋)

1. 本番用SMTPとテスト用(mockSendEmail)の切り替え事故防止
   - メール送信周りで、本番サーバに誤送信しないよう注意。
2. 認証エラーやCSR/SSR競合への対策
   - コンソールログやスタックトレースをこまめに確認し、NextAuth関連のエラーを見落とさない。
3. テストログの保存・共有
   - CIでテスト結果が出たら、スクリーンショットやHTMLログをまとめて管理。
4. 大量データを想定した負荷試験はPhase 3以降
   - まずは正常系E2Eテストを安定させるのが先決。負荷試験ツール（k6等）の導入は別途検討。

---

## 5. 削除・省略した情報

- 以前の実装履歴や具体的なコミット内容、古いチケットIDなど、現時点での作業に直接関係ない履歴情報は本ドキュメントには含めていない。
- 古いテストランナー(Jest等)の移行中に発生した課題や一時的な workaround はすでに不要となったため記載を削除。
- 各フェーズの細かいタスク単位のスケジュールは進行状況により変動があるため、本書では概略のみにとどめている。

---

## 6. 新規追加・確認したい事項 (もしあれば追記)

- (例) CI上でのRedis永続化/セッション管理の検証。
- (例) design tokens（テーマ/色設定）を共通化しているか？ NextUIなどUIライブラリをアップデート予定か？ ...etc.

上記のように、追加で議論や承認が必要な部分は今後の定例ミーティングやチャットで都度挙げてほしい。

---

## 7. Jest→Vitest移行完了後の追加対応

1. 残存Jestコードの完全削除

   - jest.config.ts / jest.setup.ts など、Jest特有のファイルや依存パッケージを整理し、すべてVitestへ統一する。

2. テストファイルの修正・増強

   - InvoicePdfButton.test.tsx など、型エラーや引数不備が報告されているテストの修正を優先する。
   - 大量データを想定したシナリオや、インボイス制度のバリデーションを中心に、ユニット/コンポーネント/E2Eテストをより充実させる。

3. CI/CDパイプラインでの安定稼働

   - .env.test などの環境変数が、CI環境でも問題なく読み込まれるかを再確認する。
   - Playwrightの並列実行やVitestのmaxWorkers設定を最適化し、15分以内のE2E完走を維持する。

4. 次フェーズ(Phase 2～Phase 3)への継続対応
   - 発注書管理や請求書管理などの残タスクを実装しながら、テストカバレッジ80%以上を保つよう心がける。
   - セキュリティ(XSS/CSRF対策)やパフォーマンス(2秒以内のページロード)もテスト観点に含め、E2Eテストなどで随時検証する。

### 請求書管理機能に関する補足 (重要)

- @req_def.md が更新され、フリーランサーや取引先法人がOPUSにログインして請求書を作成/送信できる機能(主にFR-10)を正式にサポートすることになった。
- ただし、外部ユーザー向けロール設定や、UI制御(外部ユーザー用ダッシュボードなど)が必要となるため、別途検討が必要。
- (FR-14) で示されるように、外部ツールで作られたPDFを受領して登録するフローも引き続きサポートする。

---

## 8. その他の要望・注意事項

1. 本番用SMTPとテスト用(mockSendEmail)の切り替え事故防止
   - メール送信周りで、本番サーバに誤送信しないよう注意。
2. 認証エラーやCSR/SSR競合への対策
   - コンソールログやスタックトレースをこまめに確認し、NextAuth関連のエラーを見落とさない。
3. テストログの保存・共有
   - CIでテスト結果が出たら、スクリーンショットやHTMLログをまとめて管理。
4. 大量データを想定した負荷試験はPhase 3以降
   - まずは正常系E2Eテストを安定させるのが先決。負荷試験ツール(k6等)の導入は別途検討。

---

## 9. 更新履歴

- 2025/02/03:

  - @req_def.md を再度更新し、外部ユーザー(フリーランサーなど)がOPUSにログインし自ら請求書を作成・提出できる機能を明示(FR-10)。
  - 「代理作成」と「外部がOPUS上で発行する」両方を想定する形に仕様を統合。
  - (FR-14) の外部受領ケースについても併せて再確認し、二重管理にならないよう要注意。

- 2025/02/02:

  - @req_def.md の請求書受領・登録に関する追記(FR-14)。
  - 本文書にも「請求書管理は受取側が基本」な方針を提示。
  - それに伴う追加テスト(受領した請求書の登録、支払ステータス管理)を検討するよう指示。

- 2025/02/01:
  - コードレビューにより大きな不備は見つからなかったが、念のため更新履歴を追記。
  - Jest→Vitest 移行後の対応項目(セクション7)を再確認し、実装が完了済みであることを明記。
  - 今後着手予定の発注書・請求書機能まわりのテスト戦略(大量データの入力やインボイス制度など)への言及を追加。
  - 全体の体裁とファイル構成を最新の状態で維持できるよう追記。

以上が新しいエージェントに向けた最新の指示文書だよ。今後の実装やテストでは、この文書に沿った形で進めてもらえればOK。もし不明点や不備があったら教えてね。よろしく!
