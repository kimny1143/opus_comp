# 統合指示文書 (最新版)

このドキュメントは、OPUSの機能要件・テスト方針、実装計画（@implementation-plan.md）の進捗状況および現行コードの検証結果に基づき、以後の実装指示を統合した最新版です。不要となった旧指示内容は削除し、更新内容は更新履歴に記載しています。各チームは以下の内容に沿って作業を進め、定期的な進捗報告およびGitコミットによる履歴管理を徹底してください。

---

## 1. OPUSの機能要件・仕様

本システムは、業務委託先情報管理、受発注管理、請求書管理を一元的に行うWebアプリケーションです。外部フリーランサーや取引先法人もOPUSへログインし、請求書を直接作成・提出できる仕組み（FR-10）を備えています。詳細な要件や各種画面・機能の仕様については、@req_def.md に記載済みです。

---

## 2. テストフレームワークとテスト戦略

- **ユニット/コンポーネントテスト:** Vitestを活用し、80%以上のカバレッジを目標とする。
- **E2Eテスト:** Playwrightを使い、主要なユーザ操作フローをシミュレーションする。  
  テスト実行時には .env.test を利用し、CI環境とも整合性をとること。
- **設定概要:**
  - Vitest: environment "jsdom", setupFiles (例: vitest.setup.ts)、testTimeout 30000ms、maxWorkers 50%。
  - Playwright: auth.setup.ts による認証状態管理、スクリーンショットやHTMLスナップショットの出力先は test-results/。

---

## 3. 実装フェーズと計画

現時点では Phase 1（基盤整備）は完了、Phase 2（機能実装）が進行中です。@implementation-plan.md の進捗報告を踏まえ、以下の項目を優先的に実施してください。

### 3.1 型システム・フォーム改善

- InvoiceFormの型定義や初期値設定をはじめ、各フォームコンポーネントの型整合性およびバリデーションルールの統一を徹底する。
- ZodスキーマとTypeScript型の一致を確認し、型変換ロジック（toInvoiceCreateInput関数等）のテスト自動化導入を検討する。

### 3.2 請求書作成機能（FR-10）およびインボイス制度対応

- 請求書作成フォームに、インボイス制度に準拠するための登録番号、税率などの項目を追加する。
- PDF出力機能やメール送信システム（モック実装）を強化し、エンドツーエンドでの連携テストを徹底する。

### 3.3 外部ユーザー向け機能の強化

- 外部ユーザー（フリーランサー、取引先法人）のためのログイン、請求書作成・提出機能のUI/UX改善を継続する。
- ロールによるアクセス制御や承認プロセスなど、セキュリティ要件への対応を確認・強化する。

### 3.4 発注書機能およびその他連携機能の検証

- 発注書機能では、大量品目入力やステータス管理、バリデーションロジックの安定動作を再検証する。
- Playwrightを用いたE2Eテストシナリオを拡充し、各機能間の連携およびUIの不整合が無いかを確認する。

---

## 4. 今後の実装指示

- **Gitコミットと進捗報告:** 各機能実装の完了ごとに、変更点、テスト結果を詳細に報告し、Gitコミットに反映すること。
- **エラー対応:** 開発中に発見されたランタイムエラーやUIの不整合は速やかに修正し、原因と影響範囲についてドキュメント化する。
- **ドキュメント更新:** 定期的に @implementation-plan.md の進捗と連動して、本ドキュメントもアップデートし、全体の仕様と実装方針が最新の状態になるようにする。

---

## 5. 更新履歴

- 2025/02/05: 旧内容の削除およびUI/UX改善、Gitコミット徹底に関する記述を追加。
- 202X/XX/XX: @implementation-plan.md の進捗に基づく実装指示の更新（本アップデート）。

---

以上の内容に従い、各チームは実装作業を進めてください。仕様との乖離や不明点が発生した場合は速やかに管理者または責任者へ連絡すること。
