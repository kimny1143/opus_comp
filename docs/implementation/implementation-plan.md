# OPUS実装計画書

## 1. プロジェクト概要

### 1.1 システム概要

- システム名: OPUS (Outsourcing Process Unification System)
- 目的: 業務委託先管理、受発注管理、請求書管理の統合システム
- 対象ユーザー: 経理担当、購買担当など社内スタッフ

### 1.2 主要機能

- ユーザー管理 (FR-1~FR-3)
- 取引先管理 (FR-4~FR-6)
- 受発注管理 (FR-7~FR-9)
- 請求書管理 (FR-10~FR-13)

## 2. 技術スタック

### 2.1 テストフレームワーク構成

- ユニットテスト/コンポーネントテスト: Vitest
- E2Eテスト: Playwright
- 環境変数管理: .env.test(開発・CI共通)

### 2.2 テスト設定詳細

- Vitest設定:
  - environment: "jsdom"
  - setupFiles: vitest.setup.ts
  - testTimeout: 30000ms
  - maxWorkers: 50%
- Playwright設定:
  - auth.setup.tsによる認証状態管理
  - test-results/ディレクトリでのアーティファクト管理
  - 並列実行時のテスト分離対策

## 3. 実装フェーズ

### Phase 1: 基盤整備 (Week 1-2)

#### Week 1: 認証/セッション管理

- [x] セッションストレージの永続化実装
  - Redisを使用した永続化が実装済み
  - エラーハンドリングとリトライ機構も実装済み
- [x] NextAuth設定の最適化
  - JWT + Redisのハイブリッド実装
  - カスタムセッション型とコールバック実装済み
- [x] モックセッション機能の実装
  - 認証済み/未認証/ローディング状態のモック
  - テストヘルパーとアサーション実装済み

#### Week 2: テスト基盤の確立

- [x] Vitestの設定調整
  - カバレッジ設定(80%閾値)
  - テスト分離とランダム実行
  - リトライ機構の実装
- [x] Playwrightテスト環境の構築
  - 認証セットアップの実装
  - エラーハンドリングとスナップショット
  - タイムアウト最適化
- [x] CI環境での.env.test統合
  - 環境変数の統一管理
  - CI用の実行設定調整

### Phase 2: 機能実装 (Week 3-6)

#### Week 3-4: 取引先・受発注管理

- [x] 取引先CRUD機能の実装
  - 基本情報(名前、住所等)の管理
  - 銀行情報の管理
  - バリデーション実装
- [x] タグ管理システムの実装
  - タグの追加/削除
  - タグによるフィルタリングUI
- [x] 取引先検索/フィルタリング機能の実装
  - キーワード検索(取引先名、コード)
  - 区分フィルター(法人/個人)
  - ステータスフィルター(有効/無効/ブロック)
  - タグフィルター(複数選択可)
  - リスト/グリッド表示切り替え
- [ ] 発注書作成・管理機能の実装
  - 品目一覧の大量データ入力対応
  - ステータス管理システム
  - バリデーション(数量、単価など)
- [ ] 進捗管理システムの実装
  - ステータス変更履歴
  - メール通知連携

#### Week 5-6: 請求書管理

- [ ] インボイス制度対応機能の実装
- [ ] PDF出力機能の実装
- [ ] メール送信システムの実装(モック対応含む)
- [ ] ステータス管理・バリデーション実装

### Phase 3: 最適化・セキュリティ強化 (Week 7-8)

#### Week 7: パフォーマンス最適化

- [ ] 大量データ処理の最適化
- [ ] ページロード時間の改善
- [ ] E2Eテストの実行時間最適化

#### Week 8: セキュリティ対策

- [ ] HTTPS通信の確認
- [ ] XSS/CSRF対策の実装
- [ ] 権限管理システムの強化

## 4. 品質目標

### 4.1 テストカバレッジ

- ユニットテスト/コンポーネントテスト: 80%以上
- E2Eテスト実行時間: 15分以内
- 主要ページの読み込み時間: 2秒以内

### 4.2 監視項目

- テスト実行結果とスクリーンショット
- 認証エラーとCSR/SSR競合の監視
- メール送信システムの動作確認(本番/テスト環境の分離)
- パフォーマンスメトリクス(読み込み時間、メモリ使用量)

## 5. リスク管理

### 5.1 技術的リスク

- セッション管理の永続化移行における互換性
- 大量データ処理時のパフォーマンス
- テスト環境と本番環境の差異
- メール送信システムの誤送信防止

### 5.2 対策

- 段階的な機能リリースと継続的なモニタリング
- 本番環境に影響を与えないテスト用モックの実装
- 定期的なパフォーマンステストとログ分析
- 環境変数による厳密な環境分離

## 6. 承認依頼事項

以下の点について、管理者の承認を求めます:

1. 段階的実装計画の妥当性
2. テスト戦略とカバレッジ目標の適切性
3. リスク対策の十分性

この実装計画は、要件定義書(req_def.md)、テスト要件書(req_test.md)、およびPMからの指示書(fromPM.md)に基づいて作成されています。

## 7. 進捗報告

### 2025/1/31

#### 完了タスク

1. Phase 1の全タスクが完了

   - 認証/セッション管理の実装(Redis永続化、NextAuth最適化)
   - テスト基盤の確立(Vitest設定、Playwright環境構築)

2. Phase 2の一部タスクが完了
   - 取引先CRUD機能の実装
   - タグ管理システムの実装
   - Jest→Vitestへの完全移行
   - 取引先検索/フィルタリング機能の実装
     - キーワード検索(取引先名、コード)
     - 区分/ステータス/タグによるフィルタリング
     - リスト/グリッド表示切り替え
     - Vitestによるテスト実装

#### 次のステップ

1. テストフレームワーク関連の課題対応

   - 他のテストファイルのエラー修正
   - Jestの記述の完全削除
   - テストヘルパーの更新

2. 発注書作成・管理機能の実装
   - 品目一覧の実装
   - ステータス管理システムの構築
   - バリデーション機能の実装

## 8. 技術的課題の報告

### テストフレームワーク移行の残作業

以下のファイルでエラーが発生しており、対応が必要:

1. InvoicePdfButton.test.tsx

   - businessTypeプロパティの型エラー
   - モックデータの型定義の修正が必要

2. OrderItemsTable.test.tsx

   - Jestの記述が残存
   - Vitestの形式への完全移行が必要

3. Tag.test.tsx
   - 引数の数が不正
   - テストケースの修正が必要

### 対応方針

1. テストファイルの修正

   - Jestの記述を完全に削除
   - Vitestの形式に統一
   - 型定義の整理

2. テストヘルパーの更新

   - モックヘルパーの修正
   - アサーションの型定義の追加

3. CI/CD設定の確認
   - テスト実行環境の確認
   - 環境変数の設定確認
