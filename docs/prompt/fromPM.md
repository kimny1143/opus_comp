# 統合指示文書 (改訂版)

以下のドキュメントは、今段階で必要なMVP機能に絞り、余計な設定を削除した簡易構成として作業を進めるための指針です。大規模向けの機能は基本的に切り離し、まずは請求書管理を中心に動くものを完成させてください。

---

## 1. プロジェクトの原点・目的

- **OPUS (Outsourcing Process Unification System)**  
  外部のフリーランサーや取引先法人の請求書を一元管理し、発行・承認・支払い管理をスムーズに行うWebアプリケーションを目指す。
- **最優先: 請求書のMVP完成**
  - 請求書の作成・閲覧・PDF出力が可能。
  - 取引先(Vendor)管理の基本操作が可能。
  - 外部ユーザー(フリーランサー)がログインして請求書を作成できる機能をサポート。

---

## 2. シンプル構成への移行

### 2.1 優先すべきこと

1. **請求書作成～承認～PDF出力**

   - UIとデータ連携を先に固め、最低限のバリデーションを行う。
   - セキュリティ対策や高負荷対策は後で拡張可能な形にしておく。

2. **取引先管理(Vendor)**

   - 登録・編集・削除をシンプルなCRUDで実装。
   - タグ機能は最低限の実装でOK。

3. **ユーザー管理(認証)**
   - メールアドレス＋パスワードでのログイン/ログアウトのみ。
   - ロール分け(管理者/外部ユーザー)で請求書周りの操作範囲を切り替える。

### 2.2 後回しにすること

- 大量データ対応や複数サーバー構成などの大規模向け設定
- 追加のレート制限や複雑なセッション上限管理
- E2Eテスト以外の本格的負荷テスト (k6等のツール導入)
- Next.jsのマイナーアップグレード検証やCI/CD上での高度な並列実行

---

## 3. テスト方針 (Cypress)

1. **E2Eテストの対象**

   - ログイン → ダッシュボード表示 → 請求書作成のハッピーパスを最優先でカバー。
   - 取引先管理の基本CRUD (新規登録・編集・削除) を主要シナリオとしてテスト。

2. **テスト環境セットアップ**

   - DBとテスト用ユーザーの初期化 → テストプロセス起動 の順番を守る。
   - Redis 等のセッション管理が不要なら、外すか最低限の設定にとどめてOK。

3. **運用ルール**
   - 大きな仕様変更が出るまでは、E2Eテストの規模を抑え、運用しながら必要に応じてテストを追加。
   - タイムアウト値や並列実行設定は当面デフォルトに近い形で運用。実装が安定したらチューニングする。

---

## 4. タスク一覧・スケジュール

1. **請求書管理 (MVP機能)**

   - フロントエンド：1〜2日でUIの最小実装 → PDF出力を仕上げる
   - バックエンド：APIエンドポイントの最小実装(発行・ステータス管理) → 連携テスト
   - QA：E2Eテストでハッピーパス確認 → 必要に応じて微修正

2. **取引先管理 (シンプルCRUD)**

   - 実装：1〜2日。タグがあれば付け外しできる程度にする。
   - QA：正常動作の確認 → E2Eテストケースを1-2種追加

3. **ユーザー管理 (認証ロール)**
   - 複雑なレート制限等は当面見送り。
   - ログイン＆ロール別操作を確かめるテストを1本だけ作る。

---

## 5. 最終確認・方針

- **複雑な機能は実装せず、まず請求書MVPを提供する**。
- テストはCypressを中心に、主要フローをカバーすれば十分。
- 不具合報告は @escalation チャンネルへ。クリティカルなエラーがあれば即時対処し、それ以外は段階的に対応。

以上が改訂版の統合指示です。  
まずはシンプルな構成で請求書管理のMVPを完成させ、早期リリースを目指してください。

---

## 18. 新たな実装計画・実装状況に関する承認依頼

今回更新された以下の文書を確認のうえ、承認または修正点があればコメントをお願いします。

1. **@implementation-plan-20250208.md**

   - セッション管理のリファクタ方針
   - Redis を用いたSCANクリーンアップ
   - ログイン試行数のレート制限

2. **@implementation-status.md**
   - Next.js 15アップグレード検証状況
   - セキュリティ対策完了項目・残存課題
   - 動作確認フェーズとスケジュール

**承認依頼ポイント:**

- セッション管理リファクタの妥当性
- APIエンドポイント改善スケジュールと優先度
- 新規セキュリティ監視・インシデント演習計画内容
- 全体スケジュール(短期～中期)の整合性

承認・修正後、@implementation-plan-20250208.md と @implementation-status.md に反映し、管理者へ連絡してください。

---

## 19. テスト実行に関する最新の注意事項

E2Eテストが重要な局面を迎えているため、以下の点を再確認してください。

1. **Cypressのタイムアウト・リトライ**

   - 大量データを扱うテストはタイムアウト設定を十分に大きくし、リトライ回数を安易に増やさない。
   - CIのリソース制限を踏まえ、並列数は2〜3に抑制。

2. **ログインフローの確認**

   - Next.js 15での認証ページ・Middlewareが変更されている可能性あり。
   - セッションの確立やログインフォーム挙動を改めて検証すること。

3. **DB・環境変数の再設定**

   - テスト開始前にDB再作成とRedis全キー削除を行う。
   - ステージング環境での高負荷トラブルを避けるため、常時リソースを監視する。

4. **手動検証の併用**
   - E2Eテストだけでなく、ログ出力を活用した手動確認も継続する。
   - トラブル発生時は@escalationチャンネルへ報告し、原因を協議すること。

---

## 20. E2Eテストエスカレーション報告に基づく重要指示

@escalation-report-20250208-e2e.md の報告を踏まえ、最優先で対応してください。

1. **認証フローのテスト不具合**

   - テスト実行中にブラウザが閉じられる/終了する現象がないか調査し、セッション管理ロジックや環境変数のロード順を再点検。

2. **ページナビゲーションの問題**

   - baseUrlやルーティング仕様を見直し、`cy.get()`, `cy.intercept()` など適切な待機・モック手法を導入。

3. **セットアップスクリプトエラー**

   - DBクリアとRedis初期化の競合を防ぐ。
   - デバッグログの拡充とCIログの収集を強化。

4. **リソース不足によるブラウザ強制終了**

   - CIでの並列数を抑え、実行時間を短縮。
   - CPU/メモリ監視を徹底し、過負荷時はテストを中断して原因を追究。

---

## 21. 断定的な検証結果と実施指示

以下の手順を「必須」として実施し、E2Eテスト安定化とセッション問題を解消してください。

1. **テスト環境の徹底初期化**

   - DB再作成 → Redisキー全削除 → 環境変数再設定 → テストプロセス再起動
   - クリーンな状態でテストを開始し、不整合を根絶する。

2. **セッション管理の厳格運用**

   - 未認証セッションのTTLを短くし、IPレート制限を確実に導入。
   - 認証済みセッションの上限(例: 5)を厳守し、超過時には古いセッションを破棄。

3. **Cypressの並列実行とタイムアウト設定**

   - CI環境では並列数を2～3に固定。
   - `defaultCommandTimeout` などを15秒以上に設定し、1テストあたりのリトライは1回までにする。
   - フレイキーテストを減らすため、余計な`cy.wait()`ではなく`cy.get().should()`などのUI待機を活用。

4. **デバッグログの拡充と監視**
   - スクリーンショット/ビデオ録画機能を活用し、失敗時の様子を完全に記録。
   - RedisログをDEBUGレベルにしてセッション増減を可視化。
   - 大量エラー発生時は速やかにテストを中断し、原因を特定する。

---

## 22. E2Eテストエスカレーション報告(第2報)に基づく追加指示

@escalation-report-20250208-e2e-update2.md にて指摘されたセッション管理の不具合と承認依頼事項を受け、下記を確認・実施してください。

1. **セッション管理の妥当性**

   - 未認証セッションTTL(30分推奨)やレート制限閾値が十分か再確認。
   - 認証済みセッション上限(5)の適切性や再生成タイミングを検証し、必要があれば再調整。

2. **パフォーマンス影響の検証**

   - Redis負荷を定期的にモニタリングし、SCANクリーンアップの実行コストを可視化。
   - 大量セッション下でのアプリ応答性を検証し、同時リクエスト時のボトルネックを洗い出す。

3. **セキュリティ面の強化**

   - DoS対策としてレート制限の閾値・ブロック期間設定を見直す。
   - セッション固定攻撃対策(セッション再生成の安全性、フィンガープリント検証)を再点検。

4. **承認依頼事項(設計変更・クリーンアップ戦略・エラーハンドリング)**

   - 設計差分(未認証セッションの別TTL/クリーンアップ方式変更など)をチーム内で周知し、早急に承認を得る。
   - エラーハンドリング方針やリトライ実装について、ログ詳細や監視体制も含めて最終レビューを行う。

5. **今後の対応計画**
   - 短期: セッション管理改善の設計承認 → 実装/テスト → 運用フェーズへ移行
   - 中長期: スケーラビリティ向上策(分散管理・キャッシュ戦略)、運用管理(アラート基準や管理ツール整備)

上記の追加指示を踏まえ、早急にセッション管理修正の承認作業とテスト体制の強化を進めてください。必要事項を @implementation-status.md に反映したうえで、エスカレーション先と連携を図って最終決定を行ってください。

---

更新日: 2025/2/8  
作成者: 開発チーム
