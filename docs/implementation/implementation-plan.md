# OPUS実装計画書

## 1. プロジェクト概要

### 1.1 システム概要

- システム名: OPUS (Outsourcing Process Unification System)
- 目的: 業務委託先管理、受発注管理、請求書管理の統合システム
- 対象ユーザー: 経理担当、購買担当など社内スタッフ

### 1.2 主要機能

- ユーザー管理 (FR-1~FR-3)
- 取引先管理 (FR-4~FR-6)
- 受発注管理 (FR-7~FR-9)
- 請求書管理 (FR-10~FR-13)

## 2. 技術スタック

### 2.1 テストフレームワーク構成

- ユニットテスト/コンポーネントテスト: Vitest
- E2Eテスト: Playwright
- 環境変数管理: .env.test(開発・CI共通)

### 2.2 テスト設定詳細

- Vitest設定:
  - environment: "jsdom"
  - setupFiles: vitest.setup.ts
  - testTimeout: 30000ms
  - maxWorkers: 50%
- Playwright設定:
  - auth.setup.tsによる認証状態管理
  - test-results/ディレクトリでのアーティファクト管理
  - 並列実行時のテスト分離対策

## 3. 実装フェーズ

### Phase 1: 基盤整備 (Week 1-2)

#### Week 1: 認証/セッション管理

- [x] セッションストレージの永続化実装
  - Redisを使用した永続化が実装済み
  - エラーハンドリングとリトライ機構も実装済み
- [x] NextAuth設定の最適化
  - JWT + Redisのハイブリッド実装
  - カスタムセッション型とコールバック実装済み
- [x] モックセッション機能の実装
  - 認証済み/未認証/ローディング状態のモック
  - テストヘルパーとアサーション実装済み

#### Week 2: テスト基盤の確立

- [x] Vitestの設定調整
  - カバレッジ設定(80%閾値)
  - テスト分離とランダム実行
  - リトライ機構の実装
- [x] Playwrightテスト環境の構築
  - 認証セットアップの実装
  - エラーハンドリングとスナップショット
  - タイムアウト最適化
- [x] CI環境での.env.test統合
  - 環境変数の統一管理
  - CI用の実行設定調整

### Phase 2: 機能実装 (Week 3-6)

#### Week 3-4: 取引先・受発注管理

- [x] 取引先CRUD機能の実装
  - 基本情報(名前、住所等)の管理
  - 銀行情報の管理
  - バリデーション実装
- [x] タグ管理システムの実装
  - タグの追加/削除
  - タグによるフィルタリングUI
- [x] 取引先検索/フィルタリング機能の実装
  - キーワード検索(取引先名、コード)
  - 区分フィルター(法人/個人)
  - ステータスフィルター(有効/無効/ブロック)
  - タグフィルター(複数選択可)
  - リスト/グリッド表示切り替え
- [ ] 発注書作成・管理機能の実装
  - 品目一覧の大量データ入力対応
  - ステータス管理システム
  - バリデーション(数量、単価など)
- [ ] 進捗管理システムの実装
  - ステータス変更履歴
  - メール通知連携

#### Week 5-6: 請求書管理

- [ ] インボイス制度対応機能の実装
- [ ] PDF出力機能の実装
- [ ] メール送信システムの実装(モック対応含む)
- [ ] ステータス管理・バリデーション実装

### Phase 3: 最適化・セキュリティ強化 (Week 7-8)

#### Week 7: パフォーマンス最適化

- [ ] 大量データ処理の最適化
- [ ] ページロード時間の改善
- [ ] E2Eテストの実行時間最適化

#### Week 8: セキュリティ対策

- [ ] HTTPS通信の確認
- [ ] XSS/CSRF対策の実装
- [ ] 権限管理システムの強化

## 4. 品質目標

### 4.1 テストカバレッジ

- ユニットテスト/コンポーネントテスト: 80%以上
- E2Eテスト実行時間: 15分以内
- 主要ページの読み込み時間: 2秒以内

### 4.2 監視項目

- テスト実行結果とスクリーンショット
- 認証エラーとCSR/SSR競合の監視
- メール送信システムの動作確認(本番/テスト環境の分離)
- パフォーマンスメトリクス(読み込み時間、メモリ使用量)

## 5. リスク管理

### 5.1 技術的リスク

- セッション管理の永続化移行における互換性
- 大量データ処理時のパフォーマンス
- テスト環境と本番環境の差異
- メール送信システムの誤送信防止

### 5.2 対策

- 段階的な機能リリースと継続的なモニタリング
- 本番環境に影響を与えないテスト用モックの実装
- 定期的なパフォーマンステストとログ分析
- 環境変数による厳密な環境分離

## 6. 承認依頼事項

以下の点について、管理者の承認を求めます:

1. 段階的実装計画の妥当性
2. テスト戦略とカバレッジ目標の適切性
3. リスク対策の十分性

この実装計画は、要件定義書(req_def.md)、テスト要件書(req_test.md)、およびPMからの指示書(fromPM.md)に基づいて作成されています。

## 7. 進捗報告

### 2025/1/31

#### 完了タスク

1. Phase 1の全タスクが完了

   - 認証/セッション管理の実装(Redis永続化、NextAuth最適化)
   - テスト基盤の確立(Vitest設定、Playwright環境構築)

2. Phase 2の一部タスクが完了

   - 取引先CRUD機能の実装
   - タグ管理システムの実装
   - Jest→Vitestへの完全移行
   - 取引先検索/フィルタリング機能の実装
     - キーワード検索(取引先名、コード)
     - 区分/ステータス/タグによるフィルタリング
     - リスト/グリッド表示切り替え
     - Vitestによるテスト実装
   - 取引先ポータルの実装
     - 基本UI構造の実装
     - 請求書一覧表示
     - ステータス別集計
     - 請求書作成ボタンの配置
     - 取引先情報との連携
     - 命名の最適化（フリーランサー→取引先ポータル）

3. テストフレームワーク関連の課題対応完了
   - InvoicePdfButton.test.tsx
     - 型エラーの修正(bankInfoをJSON文字列化)
     - QualifiedInvoice型の適用
   - OrderItemsTable.test.tsx
     - Jest関連の関数をVitest関数に変更
   - Tag.test.tsx
     - toHaveClass()の引数形式を修正

#### 次のステップ

1. 取引先ポータルの機能拡充

   - [ ] 請求書作成フォームの実装
     - react-hook-formの設定
     - バリデーションルールの実装
     - エラーハンドリングの実装
   - [ ] PDF出力機能の実装
   - [ ] メール通知システムの実装

2. 発注書作成・管理機能の実装

   - [x] 品目一覧の大量データ対応
     - 仮想スクロールによるパフォーマンス最適化
     - リアルタイムバリデーション実装
     - 入力値の変更時のdebounce処理追加
   - [x] ステータス管理システムの構築
     - ステータス変更履歴の表示
     - ステータス遷移の制御
     - 通知機能の実装
   - [x] バリデーション機能の実装
     - バリデーションスキーマの定義
     - エラー表示コンポーネントの実装
     - アクセシビリティ対応

## 8. 技術的課題の報告

### 現在の課題

1. 発注書機能の実装における課題

   - [x] 大量データ入力時のパフォーマンス最適化
     - 仮想スクロールの導入完了
     - 入力値の変更時のdebounce処理実装
     - バリデーション処理の最適化
   - [x] ステータス管理システムの設計
     - ステータス変更履歴の実装
     - 通知システムの実装
     - テストの整備
   - [ ] バリデーションルールの整理

2. 請求書管理機能の実装準備

   - インボイス制度対応の要件整理
   - PDF出力機能の技術選定
   - メール送信システムのモック設計

3. 請求書フォームの型定義に関する課題

   - [ ] `InvoiceFormDataWithRHF`の型定義の見直し
     - `items`の必須フィールドが省略可能として扱われている問題
       - 初期値で必須フィールドを適切に設定
       - `itemName`、`quantity`などの必須プロパティの型を確実に設定
     - `tags`の必須フィールドが省略可能として扱われている問題
       - `name`プロパティを必須として扱うよう初期値を修正
     - `AccountType` enumの型互換性の問題
       - 文字列リテラルではなく`AccountType.ORDINARY`形式での指定に統一
   - [ ] Prismaの`Decimal`型と`number`型の不整合の解決
     - フォーム側での`number`型の使用
     - DB操作時の型変換処理の実装
   - [ ] スキーマ定義とフォームの型の整合性確保
     - zodスキーマと`InvoiceFormDataWithRHF`の型定義の統一
     - 必須/オプショナルの一貫性確保

### 対応方針

1. パフォーマンス最適化

   - 仮想スクロールの導入検討
   - バッチ処理の実装
   - キャッシュ戦略の検討

2. 機能設計の整理

   - 要件定義書の詳細レビュー

3. 型システムの改善
   - 管理者との型システム設計のレビュー
   - フォームの初期状態の実装方針決定
     - 必須フィールドの適切な初期値設定
     - `AccountType` enumの正しい使用方法の統一
     - `Decimal`型の取り扱い方針の決定
   - スキーマ定義の見直し
     - zodスキーマとTypeScript型の整合性確保
     - バリデーションルールとの整合性確認

## 進捗状況

### 2024-03-XX - 型システムの改善と整理

#### 完了した作業

- InvoiceFormの型定義を改善
  - `InvoiceFormDataWithRHF`型の必須フィールドを明確化
  - `AccountType` enumの適切な使用を実装
  - `Decimal`型とnumber型の変換ロジックを整理
  - フォームの初期値設定を改善し、必須フィールドの値を保証

#### 技術的な改善点

1. スキーマと型の一貫性

   - Zodスキーマと TypeScript型の定義を完全に一致させた
   - 必須フィールドの扱いを統一（スキーマ側とTS型で一貫性を確保）

2. フォームデータの初期化

   - `baseDefaultValues`で基本の初期値を定義
   - `initialData`とのマージ時に必須フィールドの値を保証
   - 配列要素（items, tags）の必須フィールドも適切に初期化

3. 型変換の整理
   - フォーム上では`number`型として扱い、API送信時に`Prisma.Decimal`に変換
   - 型変換ロジックを`toInvoiceCreateInput`関数に集約

#### 次のステップ

1. 同様の型システムの改善を他のフォームコンポーネントにも適用
2. バリデーションメッセージの国際化対応の検討
3. 型定義の自動テスト導入の検討
