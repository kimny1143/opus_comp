# 実装計画書 (2025/2/6更新)

## 1. 現状分析と承認事項

### 1.1 進捗状況

- **基盤整備 (Phase 1):** 完了

  - MonetaryAmount型の導入と統合
  - インボイス制度対応の基本実装
  - 型システムの整備

- **機能実装 (Phase 2):** 進行中
  - セキュリティ上の脆弱性(Next.js/webpack-dev-middleware など)の対応が必要
  - 一部のUI/UX改善、外部ユーザー向け機能の強化は継続中

### 1.2 主要な課題と承認依頼事項

1. セキュリティ関連

   - Next.jsの重要な脆弱性(SSRF, Cache Poisoning等)
   - webpack-dev-middlewareの脆弱性
   - その他依存関係の脆弱性
   - 【承認依頼】Next.js 15アップグレード計画の妥当性

2. 型システム関連(対応完了)

   - ✓ 型定義の重複や散在 → Base/Db/Viewレイヤーで整理
   - ✓ MonetaryAmount型の導入による金額処理の統一
   - ✓ 型変換ロジックのテスト整備
   - 【承認依頼】型システム整備結果の確認

3. 機能実装関連
   - ✓ インボイス制度対応の基本実装
   - 外部ユーザー向け機能の改善(進行中)
   - パフォーマンス最適化(未着手)
   - 【承認依頼】インボイス制度対応の完了判定

## 2. Next.js 15アップグレード計画

### 2.1 背景と必要性

- 現在Next.js 14系で運用中
- 重要な脆弱性(SSRF, Cache Poisoning等)が検出
- webpack-dev-middlewareの脆弱性対応も必要

### 2.2 実施計画

1. 事前準備(3日間)

   - 現状のパフォーマンス計測
   - テスト環境の整備
   - バックアップの作成

2. アップグレード検証(4日間)

   - feature/next15upgradeブランチでの検証
   - 破壊的変更の影響確認
   - 必要なコード修正の実施

3. テスト実施(4日間)

   - ユニットテスト実行と修正
   - E2Eテスト実行と検証
   - パフォーマンステスト実施

4. 結果検証とレポート作成(3日間)
   - 検証結果の分析
   - リスク評価
   - 最終レポートの作成

### 2.3 リスク対策

- 詳細な事前検証の実施
- 段階的なデプロイ計画の策定
- ロールバック手順の整備
- CI/CDパイプラインでの自動テスト強化

## 3. 実装結果と検証

### 3.1 型システム整備

1. 完了した対応

   - src/types配下での型定義の集約
   - Base/Db/Viewレイヤーの明確な分離
   - MonetaryAmount型の導入と統合
   - 型変換ロジックのテスト自動化

2. 検証結果
   - ユニットテスト: 全件成功
   - 型安全性: 確認済み
   - 変換処理: 正常動作確認済み

### 3.2 インボイス制度対応

1. 実装完了項目

   - 登録番号バリデーション(T+13桁)
   - 税率計算の信頼性向上
   - PDF出力フォーマットの対応

2. 検証結果
   - バリデーション: 正常動作
   - 税計算: 複数税率対応確認
   - PDF出力: フォーマット確認済み

## 4. 今後の実装計画

### 4.1 短期的な計画(〜2週間)

1. セキュリティ対応

   - Next.js 15アップグレード
   - 依存関係の更新
   - 脆弱性対応

2. パフォーマンス最適化
   - レンダリング最適化
   - データベースクエリの効率化
   - キャッシュ戦略の導入

### 4.2 中期的な計画(〜1ヶ月)

1. UI/UX改善

   - コンポーネントライブラリの整備
   - アクセシビリティ対応
   - レスポンシブデザインの強化

2. CI/CD強化
   - テスト自動化の拡充
   - セキュリティスキャンの導入
   - デプロイプロセスの最適化

### 4.3 長期的な計画(〜3ヶ月)

1. 運用保守体制の確立
   - モニタリング体制の強化
   - インシデント対応フローの整備
   - ドキュメント管理の体系化

## 5. 判定基準

### 5.1 機能要件

- すべてのE2Eテストが成功
- 型エラーが発生しない
- 既存機能が正常動作

### 5.2 非機能要件

- ページロード時間2秒以内
- Lighthouseスコア90点以上
- メモリリーク発生なし

## 6. 進捗報告体制

### 6.1 日次報告

- テスト進捗状況
- 発見された問題点
- 対応状況

### 6.2 週次報告

- 週間サマリー
- リスク評価
- 次週の計画

### 6.3 マイルストーン報告

- 検証結果総括
- 改善提案
- 本番展開判断材料の提示

## 7. 承認依頼

上記の実装計画について、以下の3点についてご承認をお願いいたします:

1. Next.js 15アップグレード計画の実施
2. 型システム整備結果の完了判定
3. インボイス制度対応の完了判定

ご確認のほど、よろしくお願いいたします。
