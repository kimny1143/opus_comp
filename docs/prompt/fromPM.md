# 統合指示文書 (最新版)

このドキュメントは、OPUSの機能要件、テスト方針、実装計画（@implementation-plan.md）の最新進捗および検証結果に基づき、以後の実装指示を統合したものです。旧内容は削除し、更新内容は更新履歴に記載されています。各チームは以下の内容に沿って作業を進め、必要に応じて管理者へエスカレーションしてください。

---

## 1. OPUSの機能要件・仕様

本システムは、業務委託先情報管理、受発注管理、請求書管理を一元的に行うWebアプリケーションです。外部フリーランサーや取引先法人もOPUSへログインし、請求書を直接作成・提出できる仕組み（FR-10）を備えています。詳細な要件や各種画面・機能の仕様は @req_def.md を参照してください。

---

## 2. テストフレームワークとテスト戦略

- **ユニット/コンポーネントテスト:** Vitest を活用し、80%以上のカバレッジを目指す。
- **E2Eテスト:** Playwright による主要ユーザ操作フローのシミュレーション。テスト時は .env.test を利用し、CI環境との整合性を確認する。
- **その他:** tscおよびESLintによる型チェック、リント、静的解析を定期実行する。

---

## 3. 現在の実装フェーズと計画

### 3.1 Phase 1・2 の実績と課題

- **基盤整備 (Phase 1):** 完了
- **機能実装 (Phase 2):** 現在進行中
  - 型システムの整備、MonetaryAmount 型の導入、インボイス制度対応（基本実装完了）
  - セキュリティ上の脆弱性（Next.js/webpack-dev-middleware など）の対応が必要
  - 一部のUI/UX改善、外部ユーザー向け機能の強化は継続中

### 3.2 承認依頼事項

- 【承認依頼】Next.js 15 アップグレード計画の妥当性
- 【承認依頼】型システム整備結果の確認
- 【承認依頼】インボイス制度対応の完了判定

### 3.3 スケジュール概要（実装計画書より）

- **Week 1-2:** 型システム整備（完了）
- **Week 3-4:** インボイス制度対応（基本実装完了、検証・テスト実施中）
- **Week 5-6:** Next.js 15 アップグレード検証（以下詳細）
- **Week 7:** 総合テストと最終調整

---

## 4. 次フェーズ（Phase 4）に向けた実装指示

### 4.1 Next.js 15 アップグレード検証

本フェーズでは、現環境（暫定的に Next.js 14 系で運用中）を Next.js 15 へアップグレードし、下記手順で検証を実施してください。

1. **事前準備 (約3日):**
   - 現状のパフォーマンス計測とテスト環境の整備
   - バックアップの作成
2. **アップグレード検証 (約4日):**
   - "feature/next15upgrade" ブランチでアップグレード適用
   - 破壊的変更の影響確認と必要なコード修正
3. **テスト実施 (約4日):**
   - ユニットテスト、E2Eテスト、パフォーマンステストの実行
   - すべてのテストケースの確認と追加が必要な箇所の洗い出し
4. **結果検証とレポート作成 (約3日):**
   - 検証結果の詳細な分析とリスク評価
   - 最終レポートの作成および承認依頼文書の更新

### 4.2 その他の改善タスク

- **パフォーマンス最適化:**
  - 大量データクエリの効率化、APIレスポンスのキャッシュ戦略の検討
  - フロントエンドレンダリング負荷の軽減措置の実施
- **UI/UX 向上施策:**
  - 統一的なデザインコンポーネントの導入（例: Storybook 活用）
  - 外部ユーザー向け画面の操作性改善のためのユーザテストのフィードバック反映
- **CI/CD の強化:**
  - 型チェック、リント、テスト自動実行、セキュリティスキャンの定期実施およびレポート可視化
- **ドキュメント保守運用体制の確立:**
  - 型定義ガイド、テストガイド、開発手順書の定期更新とレビューの実施

---

## 5. 検証・報告と承認依頼

- 全タスクの実装完了後、リグレッションテストおよび E2E テストを通して既存機能への影響がないことを確認する。
- CI/CD パイプラインの動作状況とテストレポートを確認。問題があれば速やかに対応する。
- 各チームは進捗報告とコミット履歴の整理を徹底し、最終的なリスク評価結果および承認依頼文書を作成して管理者へ提出する。

---

## 6. コードレビュー結果と今後の実装方針

- 依存関係の更新および脆弱性対策：Next.js のアップグレード検証、webpack関連の更新が順調に進んでおり、検証環境での結果は概ね良好です。
- パフォーマンス面：一部改善の余地があるため、追加のパフォーマンス検証および最適化が必要です。
- CI/CD のテスト自動化とセキュリティ対策：今後の運用で継続的なモニタリングと迅速な対応が求められます。

【今後の実装指示】

1. feature/next15upgrade ブランチでの検証結果に基づき、Next.js 15 へのアップグレードの安全性とパフォーマンス向上策を確定する。
2. 検出された改善点については、必要なコード修正およびテストケースを追加実施する。
3. CI/CD環境で定期的なテスト実行とセキュリティスキャンを実施し、問題発生時には迅速に対応する。
4. すべての実装変更については、詳細なGitコミットと変更履歴を記録し、定期的な進捗報告を実施する。
5. 最終的なリスク評価結果とともに承認依頼文書を更新し、管理者へ提出する。

【追加のセキュリティ指示】

6. npm依存関係の脆弱性対策:
   - npm audit fix 実施後の現状を再確認し、依然として存在する高リスクの脆弱性が解消されているかを検証すること。
   - 代替パッケージの検討や、必要なコード修正を行うこと。
   - CI/CDパイプラインに自動セキュリティスキャンを組み込み、定期的にnpm audit を実行して最新の脆弱性状況をモニタリングすること。

---

## 7. 追加のnpm依存性脆弱性対策

・ bracesパッケージ (< 3.0.3) および webpack-dev-middleware (<= 5.3.3) の影響範囲の再確認。
・ Storybook関連の依存関係が依然として脆弱性を含む可能性があるため、短期的にはパッチを適用し、長期的には代替手段の検討を進めること。

---

## 8. Next.js v15 および Web 最新情報に基づく追加セキュリティ対策

- Next.js v15 で強化されたサーバーコンポーネント関連のセキュリティ強化を再チェックし、セキュリティテストを通じてリスク評価を行うこと。
- 依存パッケージの更新状況に応じて、継続的にCI/CDパイプラインへ反映し、テストケースの拡充を図ること。

---

## 9. 追加のコードレビュー指示及び次フェーズ対応

1. 【脆弱性対策の再確認】
2. 【CI/CDパイプラインの自動化強化】
3. 【Next.js 15アップグレード結果の検証】
4. 【ドキュメント更新と定例報告】

疑問点や改善提案がある場合は、管理者または責任者へエスカレーションしてください。

---

## 10. セキュリティ実装報告に基づく承認依頼事項

先日提出された「security-implementation-report-2025-02-08.md」を受け、以下の承認依頼事項について最終確認をお願いいたします。すべて問題なく承認された場合、Phase 4 移行前のタスクをクローズし、最終リリース準備へ進めます。

1. Next.js 15アップグレードの完了確認

   - 依存関係の脆弱性対応の完了
   - パフォーマンス要件（Server Response Time 80ms以下、Main Thread Work 1500ms以下）達成の確認
   - Server Components/Actions を含むセキュリティ対策の実装状況

2. CI/CD強化施策の妥当性

   - npm audit、Snykなどによるセキュリティスキャンの自動化
   - 結果の保存・分析の運用フロー
   - アラート基準やリスク評価基準の設定

3. 残存課題への対応計画
   - 開発環境のセキュリティガイドライン策定
   - セキュリティインシデント対応フローの整備
   - 教育・訓練（開発者向けセキュリティトレーニング等）

---

## 11. コードレビューおよび運用計画の確認

- **教育・訓練の必要性:**
  小規模チームであっても、将来の拡張や外部スタッフ参加を見据え、最低限のセキュリティ教育プランは整備しておくと安心。
- **テストフレームワークとCI/CD:**
  Vitest / Playwright / npm audit / Snyk などを定期実行する形で、脆弱性やパフォーマンス問題を早期検知できる運用を確立する。
- **実際のコードベースとの整合性:**
  Jest等の旧テストツールが混在していないかや、不要になったStorybook関連の依存が残っていないか、改めて確認する。

---

上記の内容を踏まえ、追加タスクやインシデント対応訓練を含めたセキュリティ強化計画を進めてください。日々のレビューやミーティングの進捗を見ながら、必要に応じてドキュメントや計画をアップデートしていきましょう。疑問点や新たな要望がある場合は、#security-training チャンネルで共有してください。

## 12. 本日のセキュリティミーティング議事メモ

- **日時:** 2025/2/8 14:00-14:30
- **参加者:** 開発チーム3名（小規模チーム）

### 12.1 ミーティング概要

1. **教育・訓練スケジュール確認**

   - 2/15のセキュリティガイドライン説明会について、時間通りに実施する。
   - オンライン学習 (2/19-23) とインシデント対応訓練 (2/28) を予定どおり進める。

2. **インシデント対応フロー再確認**

   - docs/security/incident-response-flow.md を参照しながら軽くシミュレーションを行い、特に初動対応の連絡経路を明確化した。

3. **追加タスク**
   - インシデント演習用のアカウントやダミーデータの準備を優先的に進める。
   - セキュリティガイドラインの各項目を、開発チーム内で再度レビューし、必要に応じて更新する。

### 12.2 今後の対応

- 各メンバーは自分の担当範囲におけるセキュリティリスクを再点検し、2/14までに #security-training チャンネルで共有。
- 2/15の説明会後、追加で出た質問やリクエストは速やかに @securityチーム へ連絡。
- インシデント演習でのロール分担(発見者、管理者、対策実行)を明確にしておく。

日程に変更等があった場合、再度本ドキュメントを更新して周知します。何かあれば気軽にエスカレーションしてください。

---

上記の内容を踏まえ、追加タスクやインシデント対応訓練を含めたセキュリティ強化計画を進めてください。日々のレビューやミーティングの進捗を見ながら、必要に応じてドキュメントや計画をアップデートしていきましょう。疑問点や新たな要望がある場合は、#security-training チャンネルで共有してください。

## 13. Next.js 15 アップグレードに関する最新報告（@next15-upgrade-report.md）

@next15-upgrade-report.md で報告された検証結果を踏まえ、以下の事項を確認しました:

1. 認証システム改善

   - NextAuthProviderの導入および SignInFormコンポーネントの二重マウント問題を解消
   - UX向上やアクセシビリティ対策を強化

2. パフォーマンス最適化

   - メタデータAPIの活用
   - PWAサポートの追加によるモバイル体験の向上
   - ファビコンやマニフェストの徹底実装

3. セキュリティ強化

   - セッション管理の改善
   - フォームのバリデーション強化
   - HTTPヘッダーやCSP設定の最適化

4. パフォーマンス指標

   - Server Response Time: 80ms以下を達成
   - Main Thread Work: 1500ms以下を達成
   - Core Web Vitalsをすべてクリア

5. セキュリティ評価

   - OWASP Top 10に基づく脆弱性なし
   - 適切なセッション管理およびCSPの設定を確認

6. アクセシビリティ
   - WAI-ARIAガイドライン遵守
   - スクリーンリーダー操作、キーボード操作への対応状況

本番適用にあたっては、@next15-upgrade-report.md の「4. 残存課題と対応計画」も含め、引き続きパフォーマンスモニタリングやユーザーフィードバック収集を行いながら、最終的なリリース調整を進めてください。

---

## 14. CI/CDならびにドキュメント保守運用

1. CI/CDパイプライン

   - npm audit / Snyk / Vitest / Playwrightなどによる自動テストとセキュリティスキャンの実行
   - テストレポートとアラートをSlackなどで共有し、問題発生時に迅速に対処する

2. ドキュメント保守
   - テストガイド、型定義ガイド、API仕様書などの定期レビュー
   - 変更点が発生する度にDocsへ反映し、@security-training チャンネル内で周知

---

## 15. 今後の承認依頼とリリース手順

- Next.js 15 アップグレードの本番適用について、@next15-upgrade-report.md の「承認依頼事項」を最終チェックのうえ、管理者へ提出する
- 認証フローおよび新セキュリティ設定の正式採用
- インシデント対応演習の実施後、セキュリティポリシーやガイドラインを再度更新する

---

## 16. 本日のミーティング・アクションアイテム要約

1. @next15-upgrade-report.md の内容確認と加筆
2. アップグレード完了後リリース判断の最終スケジュール確定
3. 残存課題（パフォーマンス・UX・インシデント対応）への継続的なモニタリング・改善実施

何か疑問点や新たなリスクが見つかった場合、@securityチームまたは管理者へ報告してください。

---

更新日: 2025/2/8  
作成者: 開発チーム
